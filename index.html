<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula - Discord Clone</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Map to resolve React and Lucide imports from CDNs -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
        }
    }
    </script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #313338; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        /* Custom Scrollbar Styles */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #2b2d31; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #1a1b1e; border-radius: 4px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Hash, Settings, Mic, Headphones, Plus, Search, Bell, Pin, Users, 
          HelpCircle, Gift, Sticker, Smile, SendHorizontal, Menu, X, Cookie, 
          Compass, MessageSquare, Upload, Check, Bot, MoreVertical, Phone, 
          Video, UserPlus, Inbox, Rocket, LogOut, Shield, Globe, Trash, Copy, 
          Edit2, Camera, Volume2, PhoneOff, MicOff, Signal
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from 'firebase/firestore';

        // --- FIREBASE SETUP ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Mock Data ---

        const INITIAL_DISCOVERABLE = [
          { id: 'm1', name: 'Midgar', icon: 'M', color: 'bg-indigo-500', description: 'The city of Mako energy.', ownerId: 'shinra' },
          { id: 'm2', name: 'Avalanche', icon: 'A', color: 'bg-emerald-500', description: 'Eco-warriors fighting for the planet.', ownerId: 'barret' },
          { id: 'm3', name: 'Shinra Electric', icon: 'S', color: 'bg-red-500', description: 'Powering the world, protecting the future.', ownerId: 'president' },
          { id: 'm4', name: 'Genshin Impact', icon: 'G', color: 'bg-pink-500', description: 'Step into Teyvat.', ownerId: 'mihoyo' },
          { id: 'm5', name: 'React Developers', icon: 'R', color: 'bg-cyan-500', description: 'A community for React.js enthusiasts.', ownerId: 'facebook' },
          { id: 'm6', name: 'Valorant', icon: 'V', color: 'bg-rose-500', description: 'A 5v5 character-based tactical shooter.', ownerId: 'riot' },
        ];

        const DEFAULT_CHANNELS_TEMPLATE = [
          { id: 'gen', name: 'general', type: 'text' },
          { id: 'ann', name: 'announcements', type: 'text' },
          { id: 'voi', name: 'voice-chat', type: 'voice' },
        ];

        const INITIAL_USERS = [
          { 
            id: 'u1', 
            name: 'Planet Killer', 
            status: 'online', 
            avatar: 'bg-blue-600', 
            isBot: true,
            isVerified: true,
            activity: 'Destroying Planets',
            voiceServerId: null,
            voiceChannelId: null,
            banner: 'bg-red-900',
            about: 'I am the destroyer of worlds. Do not message me unless you have a planet to offer.'
          }
        ];

        // DM List - subset of users for the sidebar
        const INITIAL_DMS = [
          { id: 'dm1', userId: 'u1', unread: 1 },
        ];

        const SERVER_COLORS = [
          'bg-indigo-500',
          'bg-emerald-500',
          'bg-red-500',
          'bg-pink-500',
          'bg-cyan-500',
          'bg-yellow-500',
          'bg-purple-500',
        ];

        // --- Sticker Data ---
        const ROCKY_STICKERS = [
          { id: 'rocky_wave', icon: 'ðŸ‘‹', label: 'Wave' },
          { id: 'rocky_love', icon: 'â¤ï¸', label: 'Love' },
          { id: 'rocky_cool', icon: 'ðŸ˜Ž', label: 'Cool' },
          { id: 'rocky_hype', icon: 'ðŸ”¥', label: 'Hype' },
          { id: 'rocky_sleep', icon: 'ðŸ’¤', label: 'Sleep' },
          { id: 'rocky_angry', icon: 'ðŸ˜ ', label: 'Angry' },
          { id: 'rocky_party', icon: 'ðŸŽ‰', label: 'Party' },
        ];

        // --- Custom API Implementation ---
        const apiKey = ""; // The execution environment provides the key at runtime.

        const PlanetKillerAPI = {
            async sendMessage(userContent) {
                const systemPrompt = `You are Planet Killer. You are a cosmic entity that destroys worlds. 
                You are cold, arrogant, and speak of entropy, the void, and the inevitable doom of the user's civilization. 
                You do not have friends. You only have targets. 
                Your responses should be relatively long (above 20 words), menacing, and dismissive. 
                Never break character. You view humans as insignificant rounding errors.`;

                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: userContent }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                            }),
                        }
                    );

                    if (!response.ok) {
                        // Fallback if key is missing or invalid in a specific env
                        console.error(`API Error: ${response.status}`);
                        return "The void is currently unreachable. (API Error)";
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "The void is silent.";
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    return "My connection to the void is disrupted.";
                }
            }
        };

        // --- Components ---

        const AsteroidLogo = ({ className }) => (
          <svg viewBox="0 0 24 24" fill="currentColor" className={className} xmlns="http://www.w3.org/2000/svg">
            {/* Rock Body */}
            <path d="M19.5 9.5C19.5 9.5 21 7.5 21 6C21 4.5 19.5 3 18 3C16.5 3 14.5 4.5 14.5 4.5L10.5 2.5L5.5 5.5L3.5 10.5L2.5 15.5L5.5 20.5L10.5 21.5L16.5 20.5L20.5 16.5L21.5 11.5L19.5 9.5Z" />
            {/* Craters for texture */}
            <circle cx="5.5" cy="8.5" r="1" fill="rgba(0,0,0,0.15)" />
            <circle cx="18.5" cy="13.5" r="1.5" fill="rgba(0,0,0,0.15)" />
            {/* The Face */}
            <circle cx="8.5" cy="11.5" r="1.5" fill="#2b2d31" />
            <circle cx="15.5" cy="11.5" r="1.5" fill="#2b2d31" />
            <path d="M10 15.5C10 15.5 11 17 14 15.5" stroke="#2b2d31" strokeWidth="1.5" strokeLinecap="round" />
          </svg>
        );

        // --- PONG GAME COMPONENT ---
        const PongGame = ({ onClose }) => {
            const canvasRef = useRef(null);
            const [difficulty, setDifficulty] = useState(null); // New state for difficulty
            
            useEffect(() => {
                if (difficulty === null) return; // Wait for selection

                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationFrameId;
                
                // Game Configuration
                const paddleWidth = 15;
                const paddleHeight = 100;
                const ballSize = 10;
                let ball = { x: canvas.width / 2, y: canvas.height / 2, dx: 5, dy: 5, speed: 7 };
                let player = { x: 20, y: canvas.height / 2 - paddleHeight / 2, score: 0 };
                // Use selected difficulty for AI speed
                let ai = { x: canvas.width - 35, y: canvas.height / 2 - paddleHeight / 2, score: 0, speed: difficulty };

                const resetBall = () => {
                    ball.x = canvas.width / 2;
                    ball.y = canvas.height / 2;
                    ball.dx = -ball.dx; // Switch serve
                    ball.speed = 7;
                };

                const update = () => {
                    // Move Ball
                    ball.x += ball.dx;
                    ball.y += ball.dy;

                    // Wall Collisions (Top/Bottom)
                    if (ball.y - ballSize < 0 || ball.y + ballSize > canvas.height) {
                        ball.dy *= -1;
                    }

                    // Paddle Collisions
                    // Player
                    if (ball.x - ballSize < player.x + paddleWidth && ball.y > player.y && ball.y < player.y + paddleHeight) {
                        ball.dx *= -1;
                        ball.x = player.x + paddleWidth + ballSize; // Push out to prevent sticking
                        // Add spin/speed
                        ball.speed += 0.5;
                        const deltaY = ball.y - (player.y + paddleHeight / 2);
                        ball.dy = deltaY * 0.2; 
                    }
                    // AI
                    if (ball.x + ballSize > ai.x && ball.y > ai.y && ball.y < ai.y + paddleHeight) {
                        ball.dx *= -1;
                        ball.x = ai.x - ballSize;
                        ball.speed += 0.5;
                        const deltaY = ball.y - (ai.y + paddleHeight / 2);
                        ball.dy = deltaY * 0.2;
                    }

                    // Scoring
                    if (ball.x < 0) {
                        ai.score++;
                        resetBall();
                    } else if (ball.x > canvas.width) {
                        player.score++;
                        resetBall();
                    }

                    // AI Movement (Simple Tracking)
                    const aiCenter = ai.y + paddleHeight / 2;
                    if (aiCenter < ball.y - 35) {
                        ai.y += ai.speed;
                    } else if (aiCenter > ball.y + 35) {
                        ai.y -= ai.speed;
                    }
                    // Keep AI in bounds
                    if (ai.y < 0) ai.y = 0;
                    if (ai.y + paddleHeight > canvas.height) ai.y = canvas.height - paddleHeight;
                };

                const draw = () => {
                    // Background
                    ctx.fillStyle = 'black';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Net
                    ctx.strokeStyle = '#333';
                    ctx.beginPath();
                    ctx.setLineDash([10, 15]);
                    ctx.moveTo(canvas.width / 2, 0);
                    ctx.lineTo(canvas.width / 2, canvas.height);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // Scores
                    ctx.fillStyle = '#444';
                    ctx.font = "bold 100px monospace";
                    ctx.textAlign = "center";
                    ctx.fillText(player.score, canvas.width / 4, 120);
                    ctx.fillText(ai.score, (canvas.width / 4) * 3, 120);

                    // Paddles
                    ctx.fillStyle = 'white';
                    ctx.fillRect(player.x, player.y, paddleWidth, paddleHeight);
                    ctx.fillRect(ai.x, ai.y, paddleWidth, paddleHeight);

                    // Ball
                    ctx.beginPath();
                    ctx.arc(ball.x, ball.y, ballSize, 0, Math.PI * 2);
                    ctx.fill();
                };

                const loop = () => {
                    update();
                    draw();
                    animationFrameId = requestAnimationFrame(loop);
                };

                const handleMouseMove = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    let mouseY = e.clientY - rect.top - paddleHeight / 2;
                    // Clamp player paddle
                    if (mouseY < 0) mouseY = 0;
                    if (mouseY + paddleHeight > canvas.height) mouseY = canvas.height - paddleHeight;
                    player.y = mouseY;
                };

                canvas.addEventListener('mousemove', handleMouseMove);
                loop();

                return () => {
                    cancelAnimationFrame(animationFrameId);
                    canvas.removeEventListener('mousemove', handleMouseMove);
                };
            }, [difficulty]); // Re-run if difficulty changes (though UI prevents changing mid-game here)

            // RENDER DIFFICULTY MENU IF NOT SELECTED
            if (difficulty === null) {
                return (
                    <div className="fixed inset-0 bg-black/95 z-[200] flex flex-col items-center justify-center font-mono text-white animate-in fade-in duration-300">
                        <h1 className="text-6xl font-black tracking-widest mb-8 text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]">PONG</h1>
                        <p className="text-gray-400 text-sm tracking-widest uppercase mb-8">Select CPU Difficulty</p>
                        <div className="flex flex-col gap-4 w-64">
                            <button onClick={() => setDifficulty(4)} className="px-6 py-3 border-2 border-green-500 text-green-500 hover:bg-green-500 hover:text-black transition-all font-bold tracking-widest uppercase rounded">Easy</button>
                            <button onClick={() => setDifficulty(8)} className="px-6 py-3 border-2 border-yellow-500 text-yellow-500 hover:bg-yellow-500 hover:text-black transition-all font-bold tracking-widest uppercase rounded">Medium</button>
                            <button onClick={() => setDifficulty(12)} className="px-6 py-3 border-2 border-red-500 text-red-500 hover:bg-red-500 hover:text-black transition-all font-bold tracking-widest uppercase rounded">Hard</button>
                            <button onClick={() => setDifficulty(20)} className="px-6 py-3 border-2 border-purple-500 text-purple-500 hover:bg-purple-500 hover:text-white hover:shadow-[0_0_20px_rgba(168,85,247,0.8)] transition-all font-bold tracking-widest uppercase rounded">Impossible</button>
                        </div>
                        <button onClick={onClose} className="mt-12 text-gray-500 hover:text-white uppercase tracking-widest text-xs">Exit Protocol</button>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-black/95 z-[200] flex flex-col items-center justify-center font-mono text-white animate-in fade-in duration-300">
                    <div className="text-center mb-6">
                        <h1 className="text-6xl font-black tracking-widest mb-2">PONG</h1>
                        <p className="text-gray-500 text-sm tracking-widest uppercase">Secret Protocol Initiated</p>
                    </div>
                    
                    <canvas 
                        ref={canvasRef} 
                        width={800} 
                        height={500} 
                        className="bg-black border-4 border-white shadow-[0_0_50px_rgba(255,255,255,0.2)] cursor-none max-w-full"
                    />
                    
                    <div className="mt-8 flex flex-col items-center gap-4">
                        <p className="text-gray-400 text-xs uppercase tracking-widest">Controls: Mouse to Move</p>
                        <button 
                            onClick={onClose} 
                            className="px-8 py-3 border-2 border-white hover:bg-white hover:text-black transition-all font-bold tracking-widest uppercase"
                        >
                            Exit Game
                        </button>
                    </div>
                </div>
            );
        };

        const PlanetKillerLogo = ({ className }) => (
          <svg viewBox="0 0 24 24" className={className} xmlns="http://www.w3.org/2000/svg">
            <defs>
              <radialGradient id="magma" cx="0.5" cy="0.5" r="0.5">
                <stop offset="0%" stopColor="#fff700" />
                <stop offset="50%" stopColor="#ff4800" />
                <stop offset="100%" stopColor="#590000" />
              </radialGradient>
            </defs>
            
            {/* Blazing Asteroid Body (The Rock) */}
            <path d="M19.5 9.5C19.5 9.5 21 7.5 21 6C21 4.5 19.5 3 18 3C16.5 3 14.5 4.5 14.5 4.5L10.5 2.5L5.5 5.5L3.5 10.5L2.5 15.5L5.5 20.5L10.5 21.5L16.5 20.5L20.5 16.5L21.5 11.5L19.5 9.5Z" fill="url(#magma)" stroke="#ff4800" strokeWidth="1.5" />
            
            {/* Burning Craters */}
            <circle cx="5.5" cy="8.5" r="1" fill="#330000" />
            <circle cx="18.5" cy="13.5" r="1.5" fill="#330000" />

            {/* Magma Spikes/Eruptions */}
            <path d="M10.5 2.5 L11.5 0.5 L12.5 2.5 Z" fill="#fff700" className="animate-pulse" />
            <path d="M20.5 16.5 L23 17 L21 18 Z" fill="#fff700" className="animate-pulse" />
            <path d="M2.5 15.5 L0.5 16 L2 17.5 Z" fill="#fff700" className="animate-pulse" />
            
            {/* RESTORED EVIL EYES */}
            <path d="M7 10 L10 12 L7 13 Z" fill="#000" stroke="#fff" strokeWidth="0.5" />
            <path d="M17 10 L14 12 L17 13 Z" fill="#000" stroke="#fff" strokeWidth="0.5" />
            
            {/* Evil Jagged Grin */}
            <path d="M7 15 Q12 20 17 15" stroke="#000" strokeWidth="1.5" strokeLinecap="round" fill="none" />
            <path d="M8 16 L9 18 L10 16 M12 17 L12.5 19 L13 17 M15 16 L16 18 L17 16" stroke="#000" strokeWidth="1" strokeLinecap="round" />
          </svg>
        );

        const RockySticker = ({ icon, size = "w-32 h-32" }) => (
          <div className={`${size} relative flex items-center justify-center transition-transform hover:scale-105 select-none`}>
            <AsteroidLogo className="w-full h-full text-[#5865F2]" />
            <div className="absolute -bottom-1 -right-1 text-[2em] leading-none filter drop-shadow-lg transform rotate-12">
              {icon}
            </div>
          </div>
        );

        const Avatar = ({ user, className = "w-8 h-8", textSize = "text-xs", statusIndicator = false }) => {
          if (!user) return null;

          // Special rendering for Planet Killer
          if (user.id === 'u1') {
             return (
                <div className="relative inline-block group">
                    {/* Blazing Particles */}
                    <div className="absolute inset-0 pointer-events-none z-0">
                        {[...Array(12)].map((_, i) => {
                            const angle = (i / 12) * 360;
                            const distance = 25;
                            const tx = Math.cos(angle * Math.PI / 180) * distance;
                            const ty = Math.sin(angle * Math.PI / 180) * distance;
                            
                            return (
                                <div 
                                    key={i}
                                    className="absolute top-1/2 left-1/2 w-1.5 h-1.5 rounded-full bg-[#ff4800] opacity-0"
                                    style={{
                                        animation: `blaze 2s infinite linear`,
                                        animationDelay: `${Math.random() * 2}s`,
                                        '--tx': `${tx}px`,
                                        '--ty': `${ty}px`
                                    }}
                                />
                            );
                        })}
                    </div>
                    
                    {/* ADDED animate-shake to the container */}
                    <div className={`${className} rounded-full bg-black flex items-center justify-center shadow-[0_0_15px_rgba(255,60,0,0.8)] relative z-10 border border-[#ff4800] animate-shake`}>
                        <PlanetKillerLogo className="w-full h-full scale-110" /> 
                    </div>
                    
                    {statusIndicator && (
                        <div className={`absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 rounded-full border-[3px] border-[#2b2d31] bg-red-600 animate-pulse z-20`} />
                    )}

                    <style>{`
                        @keyframes blaze {
                            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; box-shadow: 0 0 5px #fff700; }
                            100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0); opacity: 0; }
                        }
                        @keyframes shake {
                            0% { transform: translate(1px, 1px) rotate(0deg); }
                            10% { transform: translate(-1px, -2px) rotate(-1deg); }
                            20% { transform: translate(-3px, 0px) rotate(1deg); }
                            30% { transform: translate(3px, 2px) rotate(0deg); }
                            40% { transform: translate(1px, -1px) rotate(1deg); }
                            50% { transform: translate(-1px, 2px) rotate(-1deg); }
                            60% { transform: translate(-3px, 1px) rotate(0deg); }
                            70% { transform: translate(3px, 1px) rotate(-1deg); }
                            80% { transform: translate(-1px, -1px) rotate(1deg); }
                            90% { transform: translate(1px, 2px) rotate(0deg); }
                            100% { transform: translate(1px, -2px) rotate(-1deg); }
                        }
                        .animate-shake {
                            animation: shake 0.5s infinite;
                        }
                    `}</style>
                </div>
             );
          }

          const isImage = user.avatar && (user.avatar.startsWith('http') || user.avatar.startsWith('data:'));
          const statusColors = {
            online: 'bg-green-500',
            idle: 'bg-yellow-500',
            dnd: 'bg-red-500',
            offline: 'bg-gray-500',
          };

          return (
            <div className="relative inline-block">
              {isImage ? (
                <img 
                  src={user.avatar} 
                  alt={user.name} 
                  className={`${className} rounded-full object-cover bg-gray-700`} 
                />
              ) : (
                <div className={`${className} rounded-full ${user.avatar || 'bg-gray-500'} flex items-center justify-center ${textSize} font-bold text-gray-800`}>
                  {user.name ? user.name[0] : '?'}
                </div>
              )}
              {statusIndicator && (
                 <div className={`absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 rounded-full border-[3px] border-[#2b2d31] ${statusColors[user.status]}`} />
              )}
            </div>
          );
        };

        const BotTag = ({ verified }) => (
          <span className="ml-1.5 bg-[#5865F2] text-white text-[10px] px-1.5 rounded-[4px] flex items-center h-[15px] font-bold select-none leading-none pb-px align-middle">
            {verified && <Check size={8} strokeWidth={4} className="mr-0.5" />}
            BOT
          </span>
        );

        const ServerIcon = ({ server, active, onClick }) => (
          <div className="relative group flex items-center justify-center mb-2 w-full cursor-pointer" onClick={onClick}>
            {/* Active Indicator */}
            <div className={`absolute left-0 bg-white rounded-r-lg transition-all duration-200 
              ${active ? 'h-10 w-1 top-3' : 'h-2 w-1 top-5 opacity-0 group-hover:opacity-100 group-hover:h-5'}`} 
            />
            
            {/* Icon */}
            <div className={`w-12 h-12 flex items-center justify-center rounded-3xl transition-all duration-200 overflow-hidden text-white font-bold text-lg
              ${active ? 'bg-indigo-500 rounded-2xl' : 'bg-gray-700 group-hover:bg-indigo-500 group-hover:rounded-2xl'} ${!active && !server.img && server.color ? '' : (server.color || '')}`}>
               
               {server.img ? (
                 <img src={server.img} alt={server.name} className="w-full h-full object-cover" />
               ) : (
                 <div className={`w-full h-full flex items-center justify-center ${active ? server.color : 'bg-gray-700 group-hover:' + server.color}`}>
                    {server.icon ? server.icon : server.name[0]}
                 </div>
               )}
            </div>

            {/* Tooltip (simplified) */}
            <div className="absolute left-16 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 pointer-events-none">
              {server.name}
            </div>
          </div>
        );

        const ActionIcon = ({ icon: Icon, color, onClick, tooltip }) => (
          <div className="relative group flex items-center justify-center mb-2 w-full cursor-pointer" onClick={onClick}>
            <div className={`w-12 h-12 flex items-center justify-center rounded-3xl transition-all duration-200 overflow-hidden text-green-500 bg-gray-700 hover:text-white hover:${color} hover:rounded-2xl`}>
              <Icon size={24} className="transition-colors" />
            </div>
            <div className="absolute left-16 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 pointer-events-none">
              {tooltip}
            </div>
          </div>
        );

        const DMItem = ({ user, active, onClick, unread }) => (
          <div 
            onClick={onClick}
            className={`flex items-center px-2 py-2 mx-2 rounded cursor-pointer group transition-colors
              ${active ? 'bg-gray-700 text-white' : 'text-gray-400 hover:bg-gray-700 hover:text-gray-200'}`}
          >
            <div className="mr-3">
                <Avatar user={user} className="w-8 h-8" statusIndicator={true} />
            </div>
            <div className="flex-1 min-w-0">
                <span className={`truncate font-medium block ${active ? 'text-white' : 'text-gray-400 group-hover:text-gray-200'}`}>
                {user.name}
                {user.isBot && <BotTag verified={user.isVerified} />}
                </span>
            </div>
            {unread > 0 && (
                <div className="bg-red-500 text-white text-[10px] font-bold px-1.5 rounded-full h-4 flex items-center justify-center">
                    {unread}
                </div>
            )}
          </div>
        );

        const UserItem = ({ user, onClick }) => {
          return (
            <div onClick={onClick} className="flex items-center px-2 py-2 mx-2 rounded hover:bg-gray-700 cursor-pointer opacity-90 hover:opacity-100 group">
              <div className="mr-3">
                <Avatar user={user} className="w-8 h-8" statusIndicator={true} />
              </div>
              <div className="flex-1">
                <div className="flex items-center">
                  <div className="text-sm font-medium text-gray-200 mr-1 group-hover:underline">{user.name}</div>
                  {user.isBot && <BotTag verified={user.isVerified} />}
                </div>
                {user.activity && (
                     <div className="text-xs text-gray-400 truncate max-w-[140px]">{user.activity}</div>
                )}
              </div>
            </div>
          );
        };

        const Message = ({ message, user, isMentioned }) => {
          // Fallback to message author data if user not found in local list (for multiplayer support)
          const displayUser = user || message.author || { name: 'Unknown', avatar: 'bg-gray-500', isBot: false };
          
          const isSticker = message.content.startsWith('::sticker::');
          const stickerData = isSticker ? ROCKY_STICKERS.find(s => s.id === message.content.replace('::sticker::', '')) : null;

          // Function to highlight mentions in text
          const renderContent = () => {
            if (isSticker && stickerData) {
                return <RockySticker icon={stickerData.icon} />;
            }

            if (!isMentioned) return message.content;
            
            // Simple split to wrap the specific mention
            const parts = message.content.split(/(@\S+)/g);
            return parts.map((part, i) => {
              if (part.startsWith('@')) {
                return <span key={i} className="bg-[#3c4270] text-[#c9cdfb] rounded px-1 cursor-pointer hover:bg-[#5865f2] hover:text-white transition-colors font-medium">{part}</span>;
              }
              return part;
            });
          };

          return (
            <div className={`group flex px-4 py-1 -mx-4 ${isMentioned ? 'bg-[#3c4270]/10 border-l-2 border-[#faa61a] pl-[14px]' : 'hover:bg-gray-700/30'}`}>
              <div className="mr-4 mt-0.5 cursor-pointer hover:opacity-80 flex-shrink-0">
                 <Avatar user={displayUser} className="w-10 h-10" textSize="text-sm" />
              </div>
              <div className="flex-1 min-w-0">
                <div className="flex items-center space-x-2">
                  <span className="font-medium text-white hover:underline cursor-pointer flex items-center">
                    {displayUser.name}
                    {displayUser.isBot && <BotTag verified={displayUser.isVerified} />}
                  </span>
                  <span className="text-xs text-gray-400 pt-0.5">
                    {message.timestamp}
                  </span>
                </div>
                <div className={`text-gray-300 whitespace-pre-wrap break-words leading-relaxed ${isMentioned ? 'text-white' : ''}`}>
                  {renderContent()}
                </div>
              </div>
            </div>
          );
        };

        // --- Main Application ---

        function DiscordClone() {
          // --- Persistence Helpers (Cookies) ---
          const setCookie = (name, value, days = 365) => {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            const stringValue = encodeURIComponent(JSON.stringify(value));
            document.cookie = `${name}=${stringValue};${expires};path=/`;
          };

          const getCookie = (name, defaultValue) => {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) {
                    try {
                        const stringValue = c.substring(nameEQ.length, c.length);
                        return JSON.parse(decodeURIComponent(stringValue));
                    } catch (e) {
                        return defaultValue;
                    }
                }
            }
            return defaultValue;
          };

          const deleteCookie = (name) => {
            document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          };

          // --- STATE ---
          const [authUser, setAuthUser] = useState(null); // Firebase Auth User
          
          const [appState, setAppState] = useState(() => getCookie('nebula_appState', 'welcome')); 
          const [servers, setServers] = useState(() => getCookie('nebula_servers', [])); 
          const [discoverableServers, setDiscoverableServers] = useState(INITIAL_DISCOVERABLE);
          const [activeServerId, setActiveServerId] = useState(null); 
          
          // Navigation State
          const [activeChannelId, setActiveChannelId] = useState('gen');
          const [activeDMId, setActiveDMId] = useState('friends');
          const [dms, setDms] = useState(() => getCookie('nebula_dms', INITIAL_DMS));

          // Messages - Now managed by Firebase logic primarily, defaulting to empty
          const [messages, setMessages] = useState({});
          
          const [inputMessage, setInputMessage] = useState('');
          const [showMobileSidebar, setShowMobileSidebar] = useState(false);
          const [showUserList, setShowUserList] = useState(true);
          const [showStickerPicker, setShowStickerPicker] = useState(false);
          
          const [currentUser, setCurrentUser] = useState(() => getCookie('nebula_currentUser', { 
              id: 'me', name: 'You', avatar: 'bg-indigo-400', status: 'online', banner: 'bg-indigo-500', about: 'Just a space traveler.', email: '' 
          }));
          
          const [allUsers, setAllUsers] = useState(INITIAL_USERS);
          
          // --- Firebase Init & Persistence ---
          useEffect(() => {
              const initAuth = async () => {
                  if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                      await signInWithCustomToken(auth, __initial_auth_token);
                  } else {
                      await signInAnonymously(auth);
                  }
              };
              initAuth();
              const unsubscribe = onAuthStateChanged(auth, (user) => {
                  setAuthUser(user);
              });
              return () => unsubscribe();
          }, []);

          // Sync Messages from Firestore
          useEffect(() => {
              if (!authUser) return;
              
              // We listen to the shared messages collection
              const q = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
              
              const unsubscribe = onSnapshot(q, (snapshot) => {
                  const newMessages = {};
                  snapshot.forEach(doc => {
                      const data = doc.data();
                      const key = data.contextKey;
                      if (!newMessages[key]) newMessages[key] = [];
                      newMessages[key].push({ id: doc.id, ...data });
                  });
                  
                  // Sort by creation time
                  Object.keys(newMessages).forEach(key => {
                      newMessages[key].sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                  });
                  
                  setMessages(newMessages);
              }, (error) => {
                  console.error("Error fetching messages:", error);
              });
              
              return () => unsubscribe();
          }, [authUser]);

          // Cookie Persistence for other states
          useEffect(() => { setCookie('nebula_appState', appState); }, [appState]);
          useEffect(() => { setCookie('nebula_servers', servers); }, [servers]);
          useEffect(() => { setCookie('nebula_dms', dms); }, [dms]);
          useEffect(() => { setCookie('nebula_currentUser', currentUser); }, [currentUser]);

          // Onboarding Form State
          const [tempUsername, setTempUsername] = useState('');
          const [tempEmail, setTempEmail] = useState('');
          const [tempPassword, setTempPassword] = useState('');
          const [tempAvatar, setTempAvatar] = useState(null);
          const onboardingFileInputRef = useRef(null);

          // Voice State
          const [voiceState, setVoiceState] = useState({ connected: false, channelId: null, serverId: null, stream: null });
          const [micVolume, setMicVolume] = useState(0);
          const audioContextRef = useRef(null);
          const analyserRef = useRef(null);
          const animationFrameRef = useRef(null);

          // Modal States
          const [activeModal, setActiveModal] = useState(null); 
          const [settingsTab, setSettingsTab] = useState('overview'); // 'overview' | 'roles' | 'community'
          const [userSettingsTab, setUserSettingsTab] = useState('account'); // 'account' | 'profiles'
          const [isChangingPassword, setIsChangingPassword] = useState(false);
          const [passwordForm, setPasswordForm] = useState({ current: '', new: '', confirm: '' });
          const [selectedUserProfileId, setSelectedUserProfileId] = useState(null);
          
          // New functional states
          const [isMuted, setIsMuted] = useState(false);
          const [isDeafened, setIsDeafened] = useState(false);
          const [friendsTab, setFriendsTab] = useState('online'); // 'online' | 'all'
          const [discoverSearch, setDiscoverSearch] = useState('');
          // New state for temporary shake effect
          const [isShaking, setIsShaking] = useState(false);
          // NEW: State for Pong Game
          const [showPongGame, setShowPongGame] = useState(false);

          // Form States
          const [newServerName, setNewServerName] = useState('');
          const [newServerColor, setNewServerColor] = useState(SERVER_COLORS[0]);
          const [newServerIcon, setNewServerIcon] = useState(null);
          
          // Test State for Updates
          const [showUpdateScreen, setShowUpdateScreen] = useState(false);
          
          // New Feature States
          const [newChannelName, setNewChannelName] = useState('');
          const [channelToEdit, setChannelToEdit] = useState(null); 
          const [newRoleName, setNewRoleName] = useState('');
          const [newRoleColor, setNewRoleColor] = useState(SERVER_COLORS[0]);
          
          // NEW: State for Leave Server Confirmation Modal
          const [serverToLeave, setServerToLeave] = useState(null);

          const fileInputRef = useRef(null);
          const userAvatarInputRef = useRef(null);
          
          const messagesEndRef = useRef(null);
          const chatContainerRef = useRef(null);

          // Derived state
          const activeServer = servers.find(s => s.id === activeServerId);
          // Messages context key: different if in server or DM
          const contextKey = activeServer ? `${activeServer.id}-${activeChannelId}` : activeDMId;
          const currentMessages = messages[contextKey] || [];

          // Bot Ping Listener & Planet Killer Logic
          useEffect(() => {
            if (!currentMessages.length) return;
            const lastMsg = currentMessages[currentMessages.length - 1];
            
            // Only respond if the last message was sent by 'me' (current user) to avoid infinite loops in multiplayer
            // In multiplayer, 'me' might be anyone, so we check if the author ID matches our current session ID
            // or we just check if it's NOT the bot itself.
            if (lastMsg.userId === 'u1') return; // Don't reply to self (Bot)

            // To prevent every client replying, we rely on the client who SENT the message to handle the bot response.
            // But since this is a simplified clone, we can just check if the message is fresh (handled by logic below mostly)
            // Ideally, we'd have a backend function. Here, let's just make the user who sent it trigger the bot.
            if (lastMsg.author?.id !== currentUser.id && lastMsg.userId !== 'me') return;

            // CHECK FOR PONG TRIGGER
            if (lastMsg.content.trim().toLowerCase() === 'pong') {
                setShowPongGame(true);
                return; 
            }

            const isPlanetKillerDM = contextKey === 'u1';
            const isPing = lastMsg.content.trim() === '!ping';

            if (isPing || isPlanetKillerDM) {
                // Handle the API call
                const handleBotResponse = async () => {
                    let responseContent = '';

                    if (isPing) {
                        // Simple local echo
                        await new Promise(r => setTimeout(r, 500));
                        responseContent = `@${currentUser.name} Pong! ðŸš€`;
                    } else if (isPlanetKillerDM) {
                        // Call our Custom API
                        try {
                            responseContent = await PlanetKillerAPI.sendMessage(lastMsg.content);
                        } catch (err) {
                            console.error("API Error", err);
                            responseContent = "The void is unreachable.";
                        }
                    }

                    if (responseContent) {
                        // Send Bot Message to Firestore
                        if (authUser) {
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                                userId: 'u1',
                                content: responseContent,
                                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                                createdAt: Date.now(),
                                contextKey: contextKey,
                                author: { 
                                    id: 'u1', 
                                    name: 'Planet Killer', 
                                    avatar: 'bg-blue-600', 
                                    isBot: true, 
                                    isVerified: true 
                                }
                            });
                        }

                        // Trigger shake if it's Planet Killer responding
                        if (isPlanetKillerDM) {
                            setIsShaking(true);
                            setTimeout(() => setIsShaking(false), 5000);
                        }
                    }
                };

                handleBotResponse();
            }
          }, [currentMessages, contextKey, currentUser.name, authUser]);

          useEffect(() => {
            if (appState === 'app') {
              messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }
          }, [currentMessages, contextKey, appState]);

          const handleSendMessage = async (e) => {
            e.preventDefault();
            if (!inputMessage.trim()) return;
            if (!authUser) return; // Guard against no auth

            const newMessageData = {
              userId: 'me', // Keeping for legacy, but author object is better
              content: inputMessage,
              timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
              createdAt: Date.now(),
              contextKey: contextKey,
              author: { ...currentUser, id: currentUser.id || 'unknown' } // Embed author info
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), newMessageData);
                setInputMessage('');
                setShowStickerPicker(false);
            } catch (err) {
                console.error("Error sending message:", err);
                alert("Failed to send message. Check console.");
            }
          };

          const handleSendSticker = async (stickerId) => {
            if (!authUser) return;
            
            const newMessageData = {
              userId: 'me',
              content: `::sticker::${stickerId}`,
              timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
              createdAt: Date.now(),
              contextKey: contextKey,
              author: { ...currentUser, id: currentUser.id || 'unknown' }
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), newMessageData);
                setShowStickerPicker(false);
            } catch (err) {
                console.error("Error sending sticker:", err);
            }
          };

          // Close picker when clicking outside
          useEffect(() => {
            const handleClickOutside = (event) => {
                if (showStickerPicker && !event.target.closest('.sticker-picker-container')) {
                    setShowStickerPicker(false);
                }
            };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
          }, [showStickerPicker]);

          const getUser = (id) => {
            if (id === 'me') return currentUser;
            return allUsers.find(u => u.id === id);
          };

          const handleOnboardingAvatarUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onloadend = () => {
                setTempAvatar(reader.result);
              };
              reader.readAsDataURL(file);
            }
          };

          const handleRegister = () => {
            if (!tempEmail.trim() || !tempPassword.trim() || !tempUsername.trim()) return;
            
            setCurrentUser(prev => ({ 
                ...prev, 
                name: tempUsername, 
                email: tempEmail, 
                avatar: tempAvatar || 'bg-indigo-400' 
            }));
            setAppState('cookies');
          };

          // --- Handlers for Modals/Creation ---

          const openCreateModal = () => {
            setNewServerName(`${currentUser.name}'s Server`);
            setNewServerColor(SERVER_COLORS[Math.floor(Math.random() * SERVER_COLORS.length)]);
            setNewServerIcon(null);
            setActiveModal('create');
          };

          const finalizeCreateServer = () => {
            if (!newServerName.trim()) return;
            const newId = Date.now();
            const newServer = {
              id: newId,
              name: newServerName,
              icon: newServerName.trim()[0].toUpperCase(),
              color: newServerColor,
              img: newServerIcon,
              ownerId: 'me',
              channels: [...DEFAULT_CHANNELS_TEMPLATE],
              roles: [{ id: 'r1', name: 'Owner', color: 'text-yellow-500' }],
              isCommunity: false
            };
            
            setServers([...servers, newServer]);
            setActiveServerId(newId);
            setMessages(prev => ({
                ...prev,
                'gen': [{ id: 1, userId: 'u1', content: 'Welcome to your new server! Beep boop.', timestamp: 'Now' }]
            }));
            setActiveModal(null);
          };

           const handleImageUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onloadend = () => {
                setNewServerIcon(reader.result);
              };
              reader.readAsDataURL(file);
            }
          };

          const handleUserAvatarUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onloadend = () => {
                setCurrentUser(prev => ({ ...prev, avatar: reader.result }));
              };
              reader.readAsDataURL(file);
            }
          };

          const joinServer = (server) => {
            if (!servers.find(s => s.id === server.id)) {
                // Ensure joined servers have the structure we expect
                const joinedServer = {
                    ...server,
                    channels: server.channels || [...DEFAULT_CHANNELS_TEMPLATE],
                    roles: server.roles || [],
                    // CHANGE: Use the server's actual owner ID (or 'system' fallback), not 'me'
                    ownerId: server.ownerId || 'system' 
                };
                setServers([...servers, joinedServer]);
            }
            setActiveServerId(server.id);
            setActiveModal(null);
          };

          // REPLACED: Old handleLeaveServer logic with new Modal trigger
          const handleLeaveServer = (server) => {
             setServerToLeave(server);
          };

          const confirmLeaveServer = () => {
             if (!serverToLeave) return;
             
             setServers(prev => prev.filter(s => s.id !== serverToLeave.id));
             setActiveServerId(null);
             
             if (voiceState.serverId === serverToLeave.id) {
                 handleDisconnectVoice();
             }
             setServerToLeave(null);
          };

          const handleJoinVoice = async (channelId, serverId) => {
              if (voiceState.connected && voiceState.channelId === channelId) return;
              
              try {
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Setup Audio Analysis
                audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                analyserRef.current = audioContextRef.current.createAnalyser();
                const source = audioContextRef.current.createMediaStreamSource(stream);
                source.connect(analyserRef.current);
                
                analyserRef.current.fftSize = 32;
                const bufferLength = analyserRef.current.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                // Animation Loop for Volume
                const updateVolume = () => {
                    if (!analyserRef.current) return;
                    analyserRef.current.getByteFrequencyData(dataArray);
                    
                    // Calculate average volume
                    let sum = 0;
                    for(let i = 0; i < bufferLength; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / bufferLength;
                    
                    // Normalize somewhat (0-100 range roughly)
                    setMicVolume(average);
                    animationFrameRef.current = requestAnimationFrame(updateVolume);
                };
                
                updateVolume();
                setVoiceState({ connected: true, channelId, serverId, stream });

                // Update user state to reflect voice channel presence
                setCurrentUser(prev => ({...prev, voiceServerId: serverId, voiceChannelId: channelId}));

              } catch (err) {
                console.error("Mic Error:", err);
                alert("Could not access microphone. Voice features will be visual only.");
                setVoiceState({ connected: true, channelId, serverId, stream: null });
                setCurrentUser(prev => ({...prev, voiceServerId: serverId, voiceChannelId: channelId}));
              }
          };

          const handleDisconnectVoice = () => {
              if (voiceState.stream) {
                  voiceState.stream.getTracks().forEach(track => track.stop());
              }
              if (animationFrameRef.current) {
                  cancelAnimationFrame(animationFrameRef.current);
              }
              if (audioContextRef.current) {
                  audioContextRef.current.close();
              }
              setVoiceState({ connected: false, channelId: null, serverId: null, stream: null });
              setMicVolume(0);
              setCurrentUser(prev => ({...prev, voiceServerId: null, voiceChannelId: null}));
          };

          const createChannel = async () => {
            if (!newChannelName.trim() || !activeServer) return;
            const newChan = { id: 'c-' + Date.now(), name: newChannelName.toLowerCase().replace(/\s+/g, '-'), type: 'text' };
            
            // In-memory update
            setServers(prev => prev.map(s => {
                if (s.id === activeServer.id) {
                    return {
                        ...s,
                        channels: [...(s.channels || []), newChan]
                    };
                }
                return s;
            }));

            setActiveModal(null);
            setNewChannelName('');
          };

          const updateChannel = async () => {
            if (!activeServer || !channelToEdit || !newChannelName.trim()) return;
            
            // In-memory update
            setServers(prev => prev.map(s => {
                if (s.id === activeServer.id) {
                    const updatedChannels = s.channels.map(c => 
                        c.id === channelToEdit.id ? { ...c, name: newChannelName.toLowerCase().replace(/\s+/g, '-') } : c
                    );
                    return { ...s, channels: updatedChannels };
                }
                return s;
            }));

            setActiveModal(null);
            setNewChannelName('');
            setChannelToEdit(null);
          };

          const deleteChannel = async () => {
            if (!activeServer || !channelToEdit) return;
            if (confirm(`Are you sure you want to delete #${channelToEdit.name}? This cannot be undone.`)) {
                
                // In-memory update
                setServers(prev => prev.map(s => {
                    if (s.id === activeServer.id) {
                        const updatedChannels = s.channels.filter(c => c.id !== channelToEdit.id);
                        // Reset active channel if we deleted the current one
                        if (activeChannelId === channelToEdit.id) {
                            setActiveChannelId(updatedChannels[0]?.id || null);
                        }
                        return { ...s, channels: updatedChannels };
                    }
                    return s;
                }));

                setActiveModal(null);
                setChannelToEdit(null);
            }
          };

          const openCreateChannelModal = () => {
              setNewChannelName('');
              setActiveModal('createChannel');
          };

          const openEditChannelModal = (channel, e) => {
              e.stopPropagation();
              setChannelToEdit(channel);
              setNewChannelName(channel.name);
              setActiveModal('editChannel');
          };

          const addRole = () => {
            if (!newRoleName.trim()) return;
            setServers(prev => prev.map(s => {
                if (s.id === activeServerId) {
                    return {
                        ...s,
                        roles: [...(s.roles || []), { id: Date.now(), name: newRoleName, color: newRoleColor.replace('bg-', 'text-') }]
                    };
                }
                return s;
            }));
            setNewRoleName('');
          };

          const toggleCommunity = () => {
            const server = servers.find(s => s.id === activeServerId);
            if (!server) return;
            
            const isCommunity = !server.isCommunity;
            
            // Update server state
            setServers(prev => prev.map(s => {
                if (s.id === activeServerId) return { ...s, isCommunity };
                return s;
            }));

            // Add/Remove from Discoverable
            if (isCommunity) {
                setDiscoverableServers(prev => [...prev, { ...server, description: 'A newly discovered community.' }]);
            } else {
                setDiscoverableServers(prev => prev.filter(s => s.id !== activeServerId));
            }
          };

          const openSettingsModal = () => {
            const server = servers.find(s => s.id === activeServerId);
            if (!server) return;
            setNewServerName(server.name);
            setNewServerColor(server.color || SERVER_COLORS[0]);
            setNewServerIcon(server.img || null);
            setSettingsTab('overview');
            setActiveModal('settings');
          };

          const saveServerSettings = () => {
            if (!newServerName.trim()) return;

            setServers(prev => prev.map(s => {
              if (s.id === activeServerId) {
                return {
                  ...s,
                  name: newServerName,
                  icon: newServerName.trim()[0].toUpperCase(),
                  color: newServerColor,
                  img: newServerIcon
                };
              }
              return s;
            }));
            setActiveModal(null);
          };
          
          const handleChangePassword = () => {
              if (passwordForm.new === passwordForm.confirm && passwordForm.new.length > 0) {
                  alert("Password updated successfully!");
                  setIsChangingPassword(false);
                  setPasswordForm({ current: '', new: '', confirm: '' });
              } else {
                  alert("Passwords do not match.");
              }
          };

          const handleLogout = () => {
              if (window.confirm("Are you sure you want to log out? This will clear your cookies.")) {
                  // Clear Cookies
                  deleteCookie('nebula_appState');
                  deleteCookie('nebula_servers');
                  deleteCookie('nebula_dms');
                  // We don't clear nebula_messages anymore as it's cloud-based
                  deleteCookie('nebula_currentUser');

                  // Reset State
                  setAppState('welcome');
                  setCurrentUser({ id: 'me', name: 'You', avatar: 'bg-indigo-400', status: 'online', banner: 'bg-indigo-500', about: '', email: '' });
                  setServers([]);
                  setDms(INITIAL_DMS);
                  setMessages({});
                  setTempUsername('');
                  setTempEmail('');
                  setTempPassword('');
                  setTempAvatar(null);
                  setActiveModal(null);
              }
          };

          const handleMessageUser = (userId, e) => {
              e.stopPropagation();
              setActiveDMId(userId);
              setActiveServerId(null);
              // Ensure we aren't in a voice view if we switch
              if (window.innerWidth < 768) setShowMobileSidebar(false);
          };

          const handleOpenProfile = (userId, e) => {
              e.stopPropagation();
              setSelectedUserProfileId(userId);
              setActiveModal('userProfile');
          };

          // --- Views ---

          const renderSidebarContent = () => {
            if (activeServer) {
                // --- SERVER SIDEBAR ---
                const isOwner = activeServer.ownerId === 'me';
                return (
                    <React.Fragment>
                        <div className="h-12 px-4 flex items-center justify-between shadow-sm hover:bg-gray-700/30 cursor-pointer transition-colors border-b border-gray-900/20 group">
                            <h1 className="font-bold truncate">{activeServer.name}</h1>
                            <div className="flex items-center">
                                  <UserPlus 
                                    size={18}
                                    className="text-gray-400 hover:text-green-400 mr-2 opacity-50 hover:opacity-100 transition-all"
                                    onClick={(e) => { e.stopPropagation(); alert(`Invite link for ${activeServer.name} copied!`); }}
                                    title="Invite People"
                                  />
                                  {isOwner && (
                                    <Settings
                                      size={18} 
                                      className="text-gray-400 hover:text-white mr-2 opacity-50 hover:opacity-100 transition-all cursor-pointer" 
                                      onClick={(e) => { 
                                          e.stopPropagation(); 
                                          openSettingsModal();
                                      }} 
                                      title="Server Settings"
                                    />
                                  )}
                                  <LogOut 
                                    size={18} 
                                    className="text-gray-400 hover:text-red-400 mr-2 opacity-50 hover:opacity-100 transition-all cursor-pointer" 
                                    onClick={(e) => { 
                                        e.stopPropagation(); 
                                        handleLeaveServer(activeServer); 
                                    }} 
                                    title="Leave Server"
                                  />
                                  <X size={20} className="md:hidden cursor-pointer" onClick={() => setShowMobileSidebar(false)} />
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto py-3 custom-scrollbar">
                            <div className="px-4 mb-2 flex items-center justify-between group text-gray-400 hover:text-gray-300 cursor-pointer">
                                <span className="text-xs font-bold uppercase tracking-wide">Channels</span>
                                {isOwner ? (
                                     // CHANGE: Removed opacity-0 so the button is always visible
                                     <Plus size={14} className="hover:text-white cursor-pointer" onClick={openCreateChannelModal} />
                                ) : <div />}
                            </div>
                            <div className="space-y-[2px]">
                                {(activeServer.channels || DEFAULT_CHANNELS_TEMPLATE).map(channel => (
                                <div key={channel.id} className="group/channel relative">
                                    <div 
                                        onClick={() => {
                                            if (channel.type === 'voice') {
                                                handleJoinVoice(channel.id, activeServer.id);
                                            } else {
                                                setActiveChannelId(channel.id);
                                                if (window.innerWidth < 768) setShowMobileSidebar(false);
                                            }
                                        }}
                                        className={`flex items-center px-2 py-1.5 mx-2 rounded cursor-pointer group transition-colors
                                        ${(activeChannelId === channel.id && channel.type !== 'voice') || (voiceState.channelId === channel.id && channel.type === 'voice') ? 'bg-gray-700 text-white' : 'text-gray-400 hover:bg-gray-700 hover:text-gray-200'}`}
                                    >
                                        {channel.type === 'voice' ? <Volume2 size={20} className="mr-1.5 text-gray-400 shrink-0" /> : <Hash size={20} className="mr-1.5 text-gray-400 shrink-0" />}
                                        <span className={`truncate font-medium flex-1 ${(activeChannelId === channel.id && channel.type !== 'voice') || (voiceState.channelId === channel.id && channel.type === 'voice') ? 'text-white' : 'text-gray-400 group-hover:text-gray-200'}`}>
                                            {channel.name}
                                        </span>
                                        {isOwner && (
                                            // CHANGE: Removed opacity-0 so the settings icon is always visible
                                            <Settings 
                                                size={14} 
                                                className="text-gray-400 hover:text-white ml-2 shrink-0 transition-opacity cursor-pointer"
                                                onClick={(e) => openEditChannelModal(channel, e)}
                                            />
                                        )}
                                    </div>
                                    
                                    {/* Render Users in Voice Channel */}
                                    {channel.type === 'voice' && (
                                        <div className="ml-8 mr-2 mt-1 space-y-1">
                                            {/* Show Me if connected */}
                                            {voiceState.connected && voiceState.serverId === activeServer.id && voiceState.channelId === channel.id && (
                                                <div className="flex items-center group cursor-pointer py-0.5 rounded px-1 hover:bg-gray-700/50">
                                                    <Avatar user={currentUser} className="w-6 h-6" textSize="text-[10px]" />
                                                    <span className="ml-2 text-sm truncate text-green-400 font-bold">
                                                        {currentUser.name}
                                                    </span>
                                                    <div className="ml-auto flex space-x-1">
                                                        {/* Mock Status Icons */}
                                                    </div>
                                                </div>
                                            )}
                                            {/* Show Other Users (Mock logic as they don't really join in this demo) */}
                                            {allUsers.filter(u => u.voiceServerId === activeServer.id && u.voiceChannelId === channel.id).map(u => (
                                                <div key={u.id} className="flex items-center group cursor-pointer py-0.5 rounded px-1 hover:bg-gray-700/50">
                                                    <Avatar user={u} className="w-6 h-6" textSize="text-[10px]" />
                                                    <span className="ml-2 text-sm truncate text-gray-400 group-hover:text-gray-300">
                                                        {u.name}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Voice Status Panel */}
                        {voiceState.connected && (
                            <div className="bg-[#232428] border-b border-[#1e1f22] px-2 py-2 flex items-center">
                                <div className="flex-1 min-w-0">
                                    <div className="flex items-center text-green-500 font-bold text-xs mb-0.5">
                                        {/* Dynamic Voice Visualizer */}
                                        <div className="flex items-end space-x-[2px] h-3 mr-2">
                                            <div className="w-[3px] bg-green-500 rounded-t-sm transition-all duration-75" style={{ height: `${Math.max(20, Math.min(100, micVolume * 1.5))}%` }}></div>
                                            <div className="w-[3px] bg-green-500 rounded-t-sm transition-all duration-75" style={{ height: `${Math.max(20, Math.min(100, micVolume * 0.8))}%` }}></div>
                                            <div className="w-[3px] bg-green-500 rounded-t-sm transition-all duration-75" style={{ height: `${Math.max(20, Math.min(100, micVolume * 1.2))}%` }}></div>
                                        </div>
                                        <span>Voice Connected</span>
                                    </div>
                                    <div className="text-xs text-gray-400 truncate">
                                        {servers.find(s => s.id === voiceState.serverId)?.channels.find(c => c.id === voiceState.channelId)?.name || 'Voice Channel'} / {servers.find(s => s.id === voiceState.serverId)?.name}
                                    </div>
                                </div>
                                <div 
                                    className="p-1.5 hover:bg-gray-700 rounded cursor-pointer text-gray-300 hover:text-white"
                                    onClick={handleDisconnectVoice}
                                    title="Disconnect"
                                >
                                    <PhoneOff size={18} />
                                </div>
                            </div>
                        )}
                    </React.Fragment>
                );
            } else {
                // --- HOME / DM SIDEBAR ---
                return (
                    <React.Fragment>
                        <div className="h-12 px-4 flex items-center shadow-sm border-b border-gray-900/20">
                            <button className="w-full text-left text-gray-400 bg-[#1e1f22] text-sm px-2 py-1 rounded hover:text-gray-200 transition-colors">
                                Find or start a conversation
                            </button>
                            <X size={20} className="md:hidden cursor-pointer ml-2" onClick={() => setShowMobileSidebar(false)} />
                        </div>
                        <div className="flex-1 overflow-y-auto py-3 custom-scrollbar">
                            {/* Friends Button */}
                            <div 
                                onClick={() => setActiveDMId('friends')}
                                className={`flex items-center px-2 py-2 mx-2 mb-4 rounded cursor-pointer group transition-colors ${activeDMId === 'friends' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:bg-gray-700 hover:text-gray-200'}`}
                            >
                                 <div className="w-8 h-8 flex items-center justify-center mr-3">
                                     <Users size={24} />
                                 </div>
                                 <span className="font-medium">Friends</span>
                            </div>

                            <div className="px-4 mb-2 flex items-center justify-between group text-gray-400 hover:text-gray-300">
                                <span className="text-xs font-bold uppercase tracking-wide">Direct Messages</span>
                                <Plus size={14} className="cursor-pointer" />
                            </div>
                            
                            <div className="space-y-[2px]">x
                                {dms.map(dm => {
                                    const user = getUser(dm.userId);
                                    return (
                                        <DMItem 
                                            key={dm.id} 
                                            user={user} 
                                            active={activeDMId === user.id}
                                            unread={dm.unread}
                                            onClick={() => {
                                                setActiveDMId(user.id);
                                                if (window.innerWidth < 768) setShowMobileSidebar(false);
                                            }}
                                        />
                                    );
                                })}
                            </div>
                        </div>
                    </React.Fragment>
                )
            }
          };

          const renderMainContent = () => {
            // 1. FRIENDS LIST VIEW
            if (!activeServer && activeDMId === 'friends') {
                const onlineCount = allUsers.filter(u => u.status !== 'offline').length;
                const filteredUsers = friendsTab === 'online' 
                    ? allUsers.filter(u => u.status !== 'offline')
                    : allUsers;

                return (
                    <div className="flex-1 bg-[#313338] flex flex-col min-w-0">
                        {/* Friends Header */}
                        <header className="h-12 px-4 flex items-center shadow-sm flex-shrink-0 border-b border-black/20 bg-[#313338]">
                            <div className="flex items-center text-gray-400 mr-4">
                                <Users size={24} className="mr-3" />
                                <span className="font-bold text-white mr-4">Friends</span>
                            </div>
                            <div className="h-6 w-px bg-gray-600 mr-4"></div>
                            <div className="flex space-x-4">
                                <button 
                                    onClick={() => setFriendsTab('online')}
                                    className={`${friendsTab === 'online' ? 'text-white bg-gray-600/50' : 'text-gray-400 hover:text-gray-200 hover:bg-gray-700'} px-2 py-0.5 rounded transition-colors`}
                                >
                                    Online
                                </button>
                                <button 
                                    onClick={() => setFriendsTab('all')}
                                    className={`${friendsTab === 'all' ? 'text-white bg-gray-600/50' : 'text-gray-400 hover:text-gray-200 hover:bg-gray-700'} px-2 py-0.5 rounded transition-colors`}
                                >
                                    All
                                </button>
                            </div>
                        </header>
                        
                        {/* Friends List Body */}
                        <div className="flex-1 p-8 flex flex-col overflow-y-auto custom-scrollbar">
                             <div className="text-xs font-bold text-gray-400 uppercase mb-4">
                                {friendsTab === 'online' ? `Online â€” ${onlineCount}` : `All Friends â€” ${allUsers.length}`}
                             </div>
                             
                             {filteredUsers.map(user => (
                                 <div 
                                    key={user.id} 
                                    className="flex items-center justify-between p-3 hover:bg-gray-700/50 rounded border-t border-gray-800 cursor-pointer group"
                                    onClick={(e) => handleOpenProfile(user.id, e)}
                                 >
                                     <div className="flex items-center">
                                         <Avatar user={user} className="w-9 h-9" statusIndicator={true} />
                                         <div className="ml-3">
                                             <div className="font-bold text-white flex items-center">
                                                 {user.name}
                                                 {user.isBot && <BotTag verified={user.isVerified} />}
                                             </div>
                                             <div className="text-xs text-gray-400">{user.activity || user.status}</div>
                                         </div>
                                     </div>
                                     <div className="flex items-center space-x-2">
                                         <div 
                                            className="w-9 h-9 rounded-full bg-[#2b2d31] flex items-center justify-center text-gray-400 hover:text-gray-200 group-hover:bg-[#1e1f22]"
                                            onClick={(e) => handleMessageUser(user.id, e)}
                                            title="Message"
                                         >
                                             <MessageSquare size={18} />
                                         </div>
                                         <div className="w-9 h-9 rounded-full bg-[#2b2d31] flex items-center justify-center text-gray-400 hover:text-gray-200 group-hover:bg-[#1e1f22]">
                                             <MoreVertical size={18} />
                                         </div>
                                     </div>
                                 </div>
                             ))}
                             
                             {/* "Empty" State with ROCKY THE ASTEROID */}
                             <div className="mt-8 pt-8 border-t border-gray-700 flex flex-col items-center justify-center text-center opacity-70">
                                 <div className="w-48 h-48 bg-gray-700/50 rounded-full flex items-center justify-center mb-4 text-gray-400">
                                     <AsteroidLogo className="w-24 h-24" />
                                 </div>
                                 <p className="text-gray-500">Rocky is floating in space... waiting for more friends.</p>
                             </div>
                        </div>
                    </div>
                );
            }
            
            // 2. CHAT VIEW (Server OR DM)
            const isDM = !activeServer;
            // Fix: Updated to check for activeServer channels or fallback to template
            const activeChannel = activeServer?.channels?.find(c => c.id === activeChannelId) || DEFAULT_CHANNELS_TEMPLATE[0];
            const targetName = isDM ? getUser(activeDMId)?.name : activeChannel.name;
            const targetIcon = isDM ? '@' : '#';
            
            // Check if we are in Planet Killer's DM
            const isPlanetKillerDM = isDM && activeDMId === 'u1';

            return (
                <div className={`flex-1 flex flex-col min-w-0 relative overflow-hidden ${isPlanetKillerDM ? 'bg-red-950' : 'bg-[#313338]'} ${isPlanetKillerDM && isShaking ? 'animate-shake' : ''}`}>
                     
                     {/* Planet Killer Background Particles */}
                     {isPlanetKillerDM && (
                        <div className="absolute inset-0 pointer-events-none z-0">
                            {[...Array(30)].map((_, i) => (
                                <div 
                                    key={i}
                                    className={`absolute -bottom-4 w-2 h-2 rounded-full ${['bg-red-600', 'bg-orange-500', 'bg-black'][i % 3]}`}
                                    style={{
                                        left: `${Math.random() * 100}%`,
                                        animation: `rise ${3 + Math.random() * 4}s infinite linear`,
                                        animationDelay: `-${Math.random() * 5}s`,
                                        opacity: 0.6
                                    }}
                                />
                            ))}
                            <style>{`
                                @keyframes rise {
                                    0% { transform: translateY(0) scale(1); opacity: 0.8; }
                                    100% { transform: translateY(-100vh) scale(0); opacity: 0; }
                                }
                            `}</style>
                        </div>
                     )}

                     <header className={`h-12 px-4 flex items-center shadow-sm flex-shrink-0 border-b relative z-10 ${isPlanetKillerDM ? 'bg-red-900/80 border-red-700' : 'bg-[#313338] border-black/20'}`}>
                        <Menu className="mr-4 md:hidden text-gray-300 cursor-pointer" onClick={() => setShowMobileSidebar(!showMobileSidebar)} />
                        <span className="text-gray-400 mr-2 text-2xl font-light">{targetIcon}</span>
                        <h3 className="font-bold text-white mr-4">{targetName}</h3>
                        {isDM && getUser(activeDMId)?.status && (
                             <div className={`w-2.5 h-2.5 rounded-full mr-2 ${getUser(activeDMId).status === 'online' ? 'bg-green-500' : 'bg-gray-500'}`}></div>
                        )}
                        
                        <div className="ml-auto flex items-center space-x-4 text-gray-300">
                            {/* ANNIHILATED: Non-functional buttons (Phone, Video, Search, Bell, Pin) removed */}
                            <Users 
                              size={24} 
                              className={`cursor-pointer transition-colors ${showUserList ? 'text-white' : 'text-gray-400 hover:text-gray-200'}`} 
                              onClick={() => setShowUserList(!showUserList)}
                            />
                        </div>
                     </header>

                     {/* Messages */}
                     <div className="flex-1 overflow-y-auto overflow-x-hidden custom-scrollbar flex flex-col px-4 pt-4" ref={chatContainerRef}>
                          <div className="mt-auto mb-6">
                                {isDM ? (
                                     <div className="mb-4">
                                         <Avatar user={getUser(activeDMId)} className="w-20 h-20" textSize="text-3xl" />
                                         <h1 className="text-3xl font-bold text-white mt-4 mb-1">{getUser(activeDMId)?.name}</h1>
                                         <p className="text-gray-400 text-sm">This is the beginning of your direct message history with <span className="font-bold">{getUser(activeDMId)?.name}</span>.</p>
                                     </div>
                                ) : (
                                     <>
                                        <div className="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mb-4">
                                            <Hash size={40} className="text-white" />
                                        </div>
                                        <h1 className="text-3xl font-bold text-white mb-2">Welcome to #{targetName}!</h1>
                                        <p className="text-gray-400">This is the start of the #{targetName} channel.</p>
                                     </>
                                )}
                          </div>
                          
                          <div className="flex flex-col space-y-4 pb-4">
                                {currentMessages.map((msg) => (
                                <Message 
                                    key={msg.id} 
                                    message={msg} 
                                    user={getUser(msg.userId)} 
                                    isMentioned={msg.content.includes(`@${currentUser.name}`) || msg.content.includes('@everyone')}
                                />
                                ))}
                                <div ref={messagesEndRef} />
                          </div>
                     </div>

                     {/* Input */}
                     <div className="px-4 pb-6 pt-2 flex-shrink-0">
                        <div className="bg-[#383a40] rounded-lg p-2.5 flex items-center shadow-sm">
                            {/* ANNIHILATED: Upload button removed */}
                            <form className="flex-1 ml-2" onSubmit={handleSendMessage}>
                                <input
                                    type="text"
                                    value={inputMessage}
                                    onChange={(e) => setInputMessage(e.target.value)}
                                    placeholder={`Message ${targetIcon}${targetName}`}
                                    className="w-full bg-transparent text-gray-200 placeholder-gray-500 focus:outline-none font-light"
                                />
                            </form>
                            <div className="flex items-center space-x-3 text-gray-400 ml-3">
                                {/* ANNIHILATED: Gift button removed */}
                                
                                <div className="relative sticker-picker-container">
                                    <Sticker 
                                        size={24} 
                                        className={`cursor-pointer transition-colors ${showStickerPicker ? 'text-indigo-400' : 'hover:text-gray-200'}`} 
                                        onClick={() => setShowStickerPicker(!showStickerPicker)}
                                    />
                                    {showStickerPicker && (
                                        <div className="absolute bottom-10 right-0 w-80 bg-[#2b2d31] rounded-lg shadow-2xl border border-[#1e1f22] p-4 z-50 animate-in fade-in zoom-in-95 duration-100">
                                            <div className="flex items-center justify-between mb-3">
                                                <h4 className="font-bold text-gray-300 text-xs uppercase">Rocky Stickers</h4>
                                                <div className="bg-[#5865F2] px-2 py-0.5 rounded text-[10px] text-white font-bold">NEW</div>
                                            </div>
                                            <div className="grid grid-cols-4 gap-2">
                                                {ROCKY_STICKERS.map(sticker => (
                                                    <div 
                                                        key={sticker.id}
                                                        className="aspect-square bg-[#1e1f22] rounded hover:bg-[#404249] cursor-pointer flex items-center justify-center p-2 transition-colors relative group"
                                                        onClick={() => handleSendSticker(sticker.id)}
                                                    >
                                                        <RockySticker icon={sticker.icon} size="w-full h-full" />
                                                        <span className="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-50 transition-opacity">
                                                            {sticker.label}
                                                        </span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* ANNIHILATED: Emoji button removed */}
                                {inputMessage.length > 0 && (
                                    <SendHorizontal 
                                        size={24} 
                                        className="cursor-pointer text-indigo-400 hover:text-indigo-300" 
                                        onClick={handleSendMessage}
                                    />
                                )}
                            </div>
                        </div>
                     </div>
                </div>
            );
          };

          // --- Initial Welcome Logic ---
          if (appState === 'welcome') {
            return (
              <div className="flex flex-col items-center justify-center h-screen bg-[#313338] text-white overflow-hidden relative">
                {/* Background Textures */}
                <div className="absolute inset-0 overflow-hidden pointer-events-none">
                    <AsteroidLogo className="absolute top-20 left-20 w-32 h-32 text-[#2b2d31] opacity-50 -rotate-12" />
                    <AsteroidLogo className="absolute bottom-20 right-20 w-48 h-48 text-[#2b2d31] opacity-50 rotate-45" />
                </div>

                <div className="text-center space-y-6 p-8 w-full max-w-lg bg-[#2b2d31] rounded-xl shadow-2xl relative z-10 border border-[#1e1f22] animate-in fade-in zoom-in-95 duration-300">
                  <div className="flex flex-col items-center">
                     <div className="w-16 h-16 bg-indigo-500 rounded-full flex items-center justify-center mb-4 shadow-lg">
                        <AsteroidLogo className="w-10 h-10 text-white" />
                     </div>
                     <h1 className="text-2xl font-bold tracking-tight mb-1">Create an Account</h1>
                     <p className="text-gray-400 text-sm">Join Nebula today!</p>
                  </div>
                  
                  <div className="w-full space-y-4 text-left">
                     {/* Profile Picture Upload */}
                     <div className="flex justify-center mb-4">
                        <div 
                            className="relative group cursor-pointer"
                            onClick={() => onboardingFileInputRef.current?.click()}
                        >
                            <div className={`w-24 h-24 rounded-full flex items-center justify-center overflow-hidden border-4 border-[#1e1f22] bg-[#1e1f22] transition-colors group-hover:border-indigo-500/50`}>
                                {tempAvatar ? (
                                    <img src={tempAvatar} alt="Upload" className="w-full h-full object-cover" />
                                ) : (
                                    <div className="flex flex-col items-center justify-center text-gray-400 group-hover:text-white">
                                        <Camera size={28} className="mb-1" />
                                        <span className="text-[10px] uppercase font-bold">Upload</span>
                                    </div>
                                )}
                            </div>
                            <div className="absolute bottom-0 right-0 bg-[#5865F2] rounded-full p-1.5 border-[3px] border-[#2b2d31]">
                                <Plus size={14} className="text-white" strokeWidth={3} />
                            </div>
                            <input type="file" ref={onboardingFileInputRef} className="hidden" accept="image/*" onChange={handleOnboardingAvatarUpload} />
                        </div>
                     </div>

                     {/* Inputs */}
                     <div>
                        <label className="text-xs font-bold text-gray-400 uppercase tracking-wide ml-1">Email <span className="text-red-500">*</span></label>
                        <input 
                          type="email" 
                          value={tempEmail}
                          onChange={(e) => setTempEmail(e.target.value)}
                          className="w-full mt-1 p-2.5 bg-[#1e1f22] text-white rounded-md border-none focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-500"
                          required
                        />
                     </div>

                     <div>
                        <label className="text-xs font-bold text-gray-400 uppercase tracking-wide ml-1">Display Name <span className="text-red-500">*</span></label>
                        <input 
                          type="text" 
                          value={tempUsername}
                          onChange={(e) => setTempUsername(e.target.value)}
                          className="w-full mt-1 p-2.5 bg-[#1e1f22] text-white rounded-md border-none focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-500"
                          required
                        />
                     </div>

                     <div>
                        <label className="text-xs font-bold text-gray-400 uppercase tracking-wide ml-1">Password <span className="text-red-500">*</span></label>
                        <input 
                          type="password" 
                          value={tempPassword}
                          onChange={(e) => setTempPassword(e.target.value)}
                          className="w-full mt-1 p-2.5 bg-[#1e1f22] text-white rounded-md border-none focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-500"
                          required
                        />
                     </div>

                     <button 
                        onClick={handleRegister} 
                        disabled={!tempEmail.trim() || !tempPassword.trim() || !tempUsername.trim()}
                        className={`w-full py-3 mt-4 rounded-md font-bold text-white transition-all shadow-md transform ${(!tempEmail.trim() || !tempPassword.trim() || !tempUsername.trim()) ? 'bg-[#5865F2] opacity-50 cursor-not-allowed' : 'bg-[#5865F2] hover:bg-[#4752c4] hover:scale-[1.02]'}`}
                     >
                        Continue
                     </button>
                     
                     <div className="text-[10px] text-gray-400 mt-2 text-center">
                        By registering, you agree to Nebula's Terms of Service.
                     </div>
                  </div>
                </div>
              </div>
            );
          }

          if (appState === 'cookies') {
            return (
              <div className="flex flex-col items-center justify-center h-screen bg-[#313338] text-white p-4 overflow-hidden relative">
                <div className="absolute inset-0 bg-black/20 pointer-events-none"></div>
                <div className="bg-[#2b2d31] p-8 md:p-10 rounded-xl shadow-2xl max-w-md w-full text-center space-y-6 relative z-10 border border-gray-800">
                  <div className="flex justify-center mb-2">
                     <div className="bg-gray-800 p-4 rounded-full">
                        <Cookie size={40} className="text-yellow-500" />
                     </div>
                  </div>
                  <h2 className="text-2xl font-bold">Cookies Required</h2>
                  <p className="text-gray-300 text-sm leading-relaxed">
                    Welcome to Nebula, <span className="text-white font-bold">{currentUser.name}</span>! We use space cookies.
                  </p>
                  <div className="pt-2">
                    <button onClick={() => setAppState('app')} className="w-full px-6 py-3 bg-indigo-500 hover:bg-indigo-600 rounded-md font-bold transition-all shadow-md active:transform active:scale-95">
                      Accept Cookies
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          // --- UPDATE SCREEN OVERLAY ---
          if (showUpdateScreen) {
            return (
                <div className="fixed inset-0 bg-black z-[100] flex flex-col items-center justify-center text-red-600 font-mono animate-in fade-in duration-1000 p-4">
                    {/* ... update screen content ... */}
                    <div className="max-w-3xl w-full text-center space-y-8 p-8 border-2 border-red-900/50 bg-black/90 shadow-[0_0_50px_rgba(220,38,38,0.3)] rounded-xl relative overflow-hidden">
                         <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-red-900/20 via-transparent to-transparent opacity-50 pointer-events-none"></div>
                         
                         <div className="flex justify-center mb-6">
                            <AsteroidLogo className="w-24 h-24 text-red-600 animate-pulse" />
                         </div>

                         <h1 className="text-4xl md:text-6xl font-black tracking-tighter uppercase relative z-10 glitch-text">
                            Planet Killer Has Arrived
                         </h1>
                         
                         <div className="h-px w-3/4 bg-red-900/50 mx-auto"></div>
                         
                         <p className="text-xl md:text-2xl text-red-400 relative z-10 font-bold tracking-wide">
                            Nebula is going offline in order to make preparations.
                         </p>
                         
                         <div className="pt-12">
                            <button 
                                onClick={() => setShowUpdateScreen(false)}
                                className="text-[10px] text-red-900 hover:text-red-500 transition-colors uppercase tracking-[0.3em] border border-red-900/30 px-4 py-2 rounded hover:border-red-500/50"
                            >
                                [ Dismiss Simulation ]
                            </button>
                         </div>
                    </div>
                    <style>{`
                        @keyframes glitch {
                            0% { transform: translate(0) }
                            20% { transform: translate(-2px, 2px) }
                            40% { transform: translate(-2px, -2px) }
                            60% { transform: translate(2px, 2px) }
                            80% { transform: translate(2px, -2px) }
                            100% { transform: translate(0) }
                        }
                        .glitch-text {
                            animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite;
                            animation-delay: 2s;
                            animation-duration: 3s; /* Occasional glitch */
                        }
                    `}</style>
                </div>
            );
          }

          // --- PONG GAME OVERLAY ---
          if (showPongGame) {
              return <PongGame onClose={() => setShowPongGame(false)} />;
          }

          // --- APP RENDER ---
          return (
            <div className="flex h-screen bg-gray-900 text-gray-100 font-sans overflow-hidden select-none relative">
              
              {/* 1. Server List */}
              <nav className="w-[72px] bg-gray-900 flex flex-col items-center py-3 overflow-y-auto hide-scrollbar z-20 shadow-md">
                <div 
                    className={`w-12 h-12 rounded-2xl flex items-center justify-center transition-all cursor-pointer mb-2 hover:rounded-xl hover:bg-indigo-500 ${activeServerId === null ? 'bg-indigo-500 rounded-xl' : 'bg-[#313338] text-white'}`} 
                    onClick={() => setActiveServerId(null)}
                >
                  <AsteroidLogo className="w-8 h-8" />
                </div>
                
                <div className="w-8 h-[2px] bg-gray-700 rounded-full mb-2"></div>
                
                {servers.map(server => (
                  <ServerIcon 
                    key={server.id} 
                    server={server} 
                    active={activeServerId === server.id} 
                    onClick={() => setActiveServerId(server.id)}
                  />
                ))}

                <ActionIcon icon={Plus} color="bg-green-600" onClick={openCreateModal} tooltip="Add a Server" />
                <ActionIcon icon={Compass} color="bg-green-600" onClick={() => setActiveModal('discover')} tooltip="Explore" />
                
                <div className="w-8 h-[2px] bg-gray-700 rounded-full my-2"></div>
                <ActionIcon icon={Rocket} color="bg-red-600" onClick={() => setShowUpdateScreen(true)} tooltip="Test Update (Planet Killer)" />
              </nav>

              {/* 2. Secondary Sidebar (Channels or DMs) */}
              <div className={`w-60 bg-[#2b2d31] flex flex-col min-w-0 transition-all duration-300 absolute md:relative z-10 h-full ${showMobileSidebar ? 'left-[72px]' : '-left-64 md:left-0'}`}>
                  
                  {/* Sidebar Content */}
                  {renderSidebarContent()}

                  {/* User Status Footer */}
                  <div className="bg-[#232428] p-2 flex items-center mt-auto flex-shrink-0">
                    <div className="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold mr-2 cursor-pointer hover:opacity-80">
                        <Avatar user={currentUser} className="w-8 h-8" statusIndicator={true} />
                    </div>
                    <div className="flex-1 min-w-0 mr-1">
                        <div className="text-sm font-bold truncate text-white">{currentUser.name}</div>
                        <div className="text-xs text-gray-400 truncate">#1337</div>
                    </div>
                    <div className="flex items-center">
                        <div 
                            className={`p-1.5 rounded cursor-pointer ${isMuted ? 'text-red-500 bg-gray-800' : 'text-gray-300 hover:bg-gray-700'}`}
                            onClick={() => setIsMuted(!isMuted)}
                            title={isMuted ? "Unmute" : "Mute"}
                        >
                            {isMuted ? <MicOff size={18} /> : <Mic size={18} />}
                        </div>
                        <div 
                            className={`p-1.5 rounded cursor-pointer ${isDeafened ? 'text-red-500 bg-gray-800' : 'text-gray-300 hover:bg-gray-700'}`}
                            onClick={() => setIsDeafened(!isDeafened)}
                            title={isDeafened ? "Undeafen" : "Deafen"}
                        >
                            {isDeafened ? <PhoneOff size={18} /> : <Headphones size={18} />}
                        </div>
                        <div 
                            className="p-1.5 hover:bg-gray-700 rounded cursor-pointer text-gray-300"
                            onClick={() => {
                                setUserSettingsTab('account');
                                setActiveModal('userSettings');
                            }}
                        >
                            <Settings size={18} />
                        </div>
                    </div>
                 </div>
              </div>

              {/* 3. Main Content (Chat or Friends List) */}
              {renderMainContent()}

              {/* 4. User List (Right Sidebar - Only for Servers) */}
              {showUserList && activeServer && (
                <div className="w-60 bg-[#2b2d31] hidden lg:flex flex-col flex-shrink-0 overflow-y-auto custom-scrollbar p-3 border-l border-gray-900/20">
                    <h2 className="text-xs font-bold text-gray-400 uppercase mb-4 px-2 tracking-wide">
                        Online â€” {allUsers.filter(u => u.status !== 'offline').length + 1}
                    </h2>
                    <UserItem user={currentUser} onClick={(e) => handleOpenProfile('me', e)}/>
                    {allUsers.filter(u => u.status !== 'offline').map(user => (
                        <UserItem key={user.id} user={user} onClick={(e) => handleOpenProfile(user.id, e)}/>
                    ))}
                    <h2 className="text-xs font-bold text-gray-400 uppercase mt-6 mb-4 px-2 tracking-wide">
                        Offline â€” {allUsers.filter(u => u.status === 'offline').length}
                    </h2>
                    {allUsers.filter(u => u.status === 'offline').map(user => (
                        <UserItem key={user.id} user={user} onClick={(e) => handleOpenProfile(user.id, e)}/>
                    ))}
                </div>
              )}
              
               {/* 5. Profile / Activity (Right Sidebar - Only for Home/Friends) */}
               {showUserList && !activeServer && (
                 <div className="w-[360px] bg-[#2b2d31] hidden xl:flex flex-col flex-shrink-0 overflow-y-auto custom-scrollbar p-4 border-l border-gray-900/20">
                    <h2 className="text-xl font-bold mb-4">Active Now</h2>
                    <div className="flex-1 flex flex-col items-center justify-center text-center opacity-70">
                        <p className="font-bold text-gray-400 mb-2">It's quiet for now...</p>
                        <p className="text-sm text-gray-500 px-8">When a friend starts an activityâ€”like playing a game or hanging out on voiceâ€”we'll show it here!</p>
                    </div>
                 </div>
               )}

              {/* --- MODALS --- */}
              {activeModal === 'create' && (
                <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                    <div className="bg-white text-gray-800 rounded-lg shadow-2xl w-full max-w-md overflow-hidden relative">
                        <button onClick={() => setActiveModal(null)} className="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><X size={24} /></button>
                        <div className="p-6 text-center">
                            <h2 className="text-2xl font-bold mb-2">Customize Your Server</h2>
                            <p className="text-gray-500 text-sm mb-6">Give your new server a personality with a name and an icon.</p>
                            <div className="flex justify-center mb-6">
                                <div 
                                   className={`w-24 h-24 rounded-full ${newServerColor} flex items-center justify-center text-white text-4xl font-bold relative border-4 border-white shadow-sm cursor-pointer hover:opacity-90 overflow-hidden bg-cover bg-center`}
                                   onClick={() => fileInputRef.current?.click()}
                                   style={{ backgroundImage: newServerIcon ? `url(${newServerIcon})` : 'none' }}
                                >
                                    {!newServerIcon && (newServerName.trim() ? newServerName.trim()[0].toUpperCase() : <Upload size={32} />)}
                                    <div className="absolute top-0 right-0 bg-red-500 rounded-full p-1.5 border-2 border-white z-10"><Plus size={12} className="text-white" strokeWidth={4} /></div>
                                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} />
                                </div>
                            </div>
                            <div className="text-left mb-6">
                                <label className="text-xs font-bold text-gray-500 uppercase block mb-2">Server Name</label>
                                <input type="text" className="w-full bg-gray-200 p-2.5 rounded border-none focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800" value={newServerName} onChange={(e) => setNewServerName(e.target.value)} placeholder="Enter a server name" />
                            </div>
                              {/* Color Picker added to Create Modal for consistency */}
                              <div className="text-left mb-6">
                                <label className="text-xs font-bold text-gray-500 uppercase block mb-2">Server Color</label>
                                <div className="flex space-x-2">
                                    {SERVER_COLORS.map(color => (
                                        <div 
                                            key={color} 
                                            className={`${color} w-8 h-8 rounded-full cursor-pointer hover:scale-110 transition-transform flex items-center justify-center`}
                                            onClick={() => {
                                              setNewServerColor(color);
                                              // Optional: keep image if set, or clear it
                                            }}
                                        >
                                            {newServerColor === color && !newServerIcon && <Check size={16} className="text-white" />}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="bg-gray-100 p-4 flex justify-between items-center">
                            <button onClick={() => setActiveModal(null)} className="text-gray-500 hover:underline font-medium text-sm">Back</button>
                            <button onClick={finalizeCreateServer} className="bg-indigo-500 hover:bg-indigo-600 text-white px-8 py-2.5 rounded shadow-sm font-medium transition-colors">Create</button>
                        </div>
                    </div>
                </div>
              )}

              {/* Settings Modal (Reusing similar layout to Create) */}
              {activeModal === 'settings' && (
                <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                    <div className="bg-white text-gray-800 rounded-lg shadow-2xl w-full max-w-2xl overflow-hidden relative flex h-[500px]">
                        {/* Sidebar */}
                        <div className="w-48 bg-gray-100 p-4 flex flex-col border-r border-gray-200">
                              <h3 className="font-bold text-xs uppercase text-gray-500 mb-2">{activeServer.name}</h3>
                              <button onClick={() => setSettingsTab('overview')} className={`text-left px-2 py-1.5 rounded text-sm mb-1 ${settingsTab === 'overview' ? 'bg-gray-200 font-bold' : 'hover:bg-gray-200'}`}>Overview</button>
                              <button onClick={() => setSettingsTab('roles')} className={`text-left px-2 py-1.5 rounded text-sm mb-1 flex items-center justify-between ${settingsTab === 'roles' ? 'bg-gray-200 font-bold' : 'hover:bg-gray-200'}`}>Roles <Shield size={14}/></button>
                              <button onClick={() => setSettingsTab('community')} className={`text-left px-2 py-1.5 rounded text-sm mb-1 flex items-center justify-between ${settingsTab === 'community' ? 'bg-gray-200 font-bold' : 'hover:bg-gray-200'}`}>Community <Globe size={14}/></button>
                        </div>

                        {/* Content */}
                        <div className="flex-1 p-8 flex flex-col overflow-y-auto relative">
                              <button onClick={() => setActiveModal(null)} className="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><X size={24} /></button>
                              
                              {settingsTab === 'overview' && (
                                  <>
                                     <h2 className="text-2xl font-bold mb-6">Server Overview</h2>
                                     <div className="flex items-start space-x-6">
                                        <div className="flex-shrink-0">
                                            <div 
                                            className={`w-24 h-24 rounded-full ${newServerColor} flex items-center justify-center text-white text-4xl font-bold relative border-4 border-white shadow-sm cursor-pointer hover:opacity-90 overflow-hidden bg-cover bg-center`}
                                            onClick={() => fileInputRef.current?.click()}
                                            style={{ backgroundImage: newServerIcon ? `url(${newServerIcon})` : 'none' }}
                                            >
                                                {!newServerIcon && (newServerName.trim() ? newServerName.trim()[0].toUpperCase() : <Upload size={32} />)}
                                                <div className="absolute top-0 right-0 bg-gray-500 rounded-full p-1.5 border-2 border-white z-10"><Plus size={12} className="text-white" strokeWidth={4} /></div>
                                                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} />
                                            </div>
                                        </div>
                                        <div className="flex-1">
                                             <label className="text-xs font-bold text-gray-500 uppercase block mb-2">Server Name</label>
                                             <input type="text" className="w-full bg-gray-200 p-2.5 rounded border-none focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800 mb-4" value={newServerName} onChange={(e) => setNewServerName(e.target.value)} />
                                             
                                             <label className="text-xs font-bold text-gray-500 uppercase block mb-2">Server Color</label>
                                             <div className="flex space-x-2">
                                                 {SERVER_COLORS.map(color => (
                                                     <div key={color} className={`${color} w-6 h-6 rounded-full cursor-pointer hover:scale-110 transition-transform flex items-center justify-center`} onClick={() => setNewServerColor(color)}>
                                                         {newServerColor === color && !newServerIcon && <Check size={12} className="text-white" />}
                                                     </div>
                                                 ))}
                                             </div>
                                        </div>
                                    </div>
                                    <button onClick={saveServerSettings} className="mt-auto self-end bg-green-600 hover:bg-green-700 text-white px-8 py-2.5 rounded shadow-sm font-medium transition-colors w-fit ml-auto">Save Changes</button>
                                  </>
                              )}

                              {settingsTab === 'roles' && (
                                  <>
                                     <h2 className="text-2xl font-bold mb-2">Roles</h2>
                                     <p className="text-gray-500 text-sm mb-6">Create roles to organize your server members.</p>
                                     
                                     <div className="flex space-x-2 mb-6">
                                         <input type="text" placeholder="New Role Name" className="flex-1 bg-gray-200 p-2 rounded text-sm" value={newRoleName} onChange={(e) => setNewRoleName(e.target.value)} />
                                         <div className="flex space-x-1">
                                             {SERVER_COLORS.slice(0, 3).map(color => (
                                                 <div key={color} className={`${color} w-9 h-9 rounded cursor-pointer flex items-center justify-center`} onClick={() => setNewRoleColor(color)}>
                                                      {newRoleColor === color && <Check size={14} className="text-white" />}
                                                 </div>
                                             ))}
                                         </div>
                                         <button onClick={addRole} className="bg-indigo-500 text-white px-4 rounded text-sm">Add</button>
                                     </div>

                                     <div className="space-y-2">
                                         {(activeServer.roles || []).map(role => (
                                             <div key={role.id} className="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200">
                                                 <div className="flex items-center">
                                                      <div className={`w-3 h-3 rounded-full mr-2 ${role.color.replace('text-', 'bg-')}`}></div>
                                                      <span className={`font-medium ${role.color.replace('text-', 'text-')}`}>{role.name}</span>
                                                 </div>
                                                 <Trash size={14} className="text-gray-400 hover:text-red-500 cursor-pointer" />
                                             </div>
                                         ))}
                                         {(!activeServer.roles || activeServer.roles.length === 0) && <p className="text-gray-400 text-sm italic">No roles yet.</p>}
                                     </div>
                                  </>
                              )}

                              {settingsTab === 'community' && (
                                  <>
                                     <h2 className="text-2xl font-bold mb-4">Community Settings</h2>
                                     <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100 mb-4">
                                         <div className="flex items-center justify-between mb-2">
                                             <div className="font-bold text-indigo-900">Enable Community</div>
                                             <div 
                                                className={`w-12 h-6 rounded-full p-1 cursor-pointer transition-colors ${activeServer.isCommunity ? 'bg-green-500' : 'bg-gray-300'}`}
                                                onClick={toggleCommunity}
                                             >
                                                 <div className={`w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${activeServer.isCommunity ? 'translate-x-6' : 'translate-x-0'}`}></div>
                                             </div>
                                         </div>
                                         <p className="text-sm text-indigo-800">
                                             {activeServer.isCommunity 
                                                ? "Your server is publicly visible in Discovery! People can find and join your server."
                                                : "Enable this to allow your server to appear in Server Discovery."}
                                         </p>
                                     </div>
                                  </>
                              )}
                        </div>
                    </div>
                </div>
              )}

              {/* User Settings Modal */}
              {activeModal === 'userSettings' && (
                <div className="fixed inset-0 bg-[#313338] z-50 flex animate-in fade-in duration-200">
                    {/* Sidebar */}
                    <div className="w-[300px] bg-[#2b2d31] flex flex-col items-end pt-16 pb-4 px-4 border-r border-[#1e1f22]">
                        <div className="w-48">
                            <h3 className="font-bold text-xs uppercase text-gray-400 mb-2 px-2">User Settings</h3>
                            <div 
                                onClick={() => setUserSettingsTab('account')}
                                className={`px-2 py-1.5 rounded cursor-pointer mb-1 font-medium ${userSettingsTab === 'account' ? 'bg-[#404249] text-white' : 'text-gray-400 hover:bg-[#35373c] hover:text-gray-200'}`}
                            >
                                My Account
                            </div>
                            <div 
                                onClick={() => setUserSettingsTab('profiles')}
                                className={`px-2 py-1.5 rounded cursor-pointer mb-1 font-medium ${userSettingsTab === 'profiles' ? 'bg-[#404249] text-white' : 'text-gray-400 hover:bg-[#35373c] hover:text-gray-200'}`}
                            >
                                Profiles
                            </div>
                            <div className="h-px bg-gray-700 my-2 mx-2"></div>
                            <div 
                                onClick={handleLogout}
                                className="px-2 py-1.5 rounded cursor-pointer mb-1 font-medium text-red-400 hover:bg-[#35373c] flex items-center justify-between group"
                            >
                                Log Out
                                <LogOut size={16} className="opacity-0 group-hover:opacity-100 transition-opacity" />
                            </div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="flex-1 bg-[#313338] pt-16 px-10 overflow-y-auto relative custom-scrollbar">
                        <div className="max-w-[700px]">
                            <div className="absolute top-16 right-10 flex flex-col items-center group cursor-pointer" onClick={() => setActiveModal(null)}>
                                <div className="w-9 h-9 rounded-full border-2 border-gray-400 flex items-center justify-center text-gray-400 group-hover:border-white group-hover:text-white transition-colors">
                                    <X size={20} />
                                </div>
                                <span className="text-xs font-bold text-gray-400 mt-1 uppercase group-hover:text-white transition-colors">Esc</span>
                            </div>

                            {userSettingsTab === 'account' && (
                                <div className="animate-in slide-in-from-bottom-4 duration-300">
                                    <h2 className="text-xl font-bold text-white mb-6">My Account</h2>
                                    
                                    {/* Profile Card Preview */}
                                    <div className="bg-[#2b2d31] rounded-lg overflow-hidden mb-8">
                                        <div className={`h-24 ${currentUser.banner || 'bg-indigo-500'}`}></div>
                                        <div className="px-4 pb-4 relative">
                                            <div className="absolute -top-10 left-4">
                                                <div className="p-1.5 bg-[#2b2d31] rounded-full inline-block">
                                                    <Avatar user={currentUser} className="w-20 h-20" textSize="text-3xl" statusIndicator={true} />
                                                </div>
                                            </div>
                                            <div className="ml-28 pt-3 flex justify-between items-center">
                                                <div className="text-xl font-bold text-white">{currentUser.name}</div>
                                                <button 
                                                    onClick={() => setUserSettingsTab('profiles')}
                                                    className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-4 py-1.5 rounded text-sm font-medium transition-colors"
                                                >
                                                    Edit User Profile
                                                </button>
                                            </div>
                                            
                                            {/* Info Cards */}
                                            <div className="mt-6 bg-[#1e1f22] rounded-lg p-4 space-y-4">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <div className="text-xs font-bold text-gray-400 uppercase mb-1">Display Name</div>
                                                        <div className="text-gray-200">{currentUser.name}</div>
                                                    </div>
                                                    <button className="bg-[#313338] hover:bg-[#404249] text-gray-200 px-4 py-1.5 rounded text-sm font-medium">Edit</button>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <div className="text-xs font-bold text-gray-400 uppercase mb-1">Username</div>
                                                        <div className="text-gray-200">{currentUser.name.toLowerCase().replace(/\s/g, '')}</div>
                                                    </div>
                                                    <button className="bg-[#313338] hover:bg-[#404249] text-gray-200 px-4 py-1.5 rounded text-sm font-medium">Edit</button>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <div className="text-xs font-bold text-gray-400 uppercase mb-1">Email</div>
                                                        <div className="text-gray-200">{currentUser.email || '********@gmail.com'}</div>
                                                    </div>
                                                    <button className="bg-[#313338] hover:bg-[#404249] text-gray-200 px-4 py-1.5 rounded text-sm font-medium">Edit</button>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <div className="text-xs font-bold text-gray-400 uppercase mb-1">Phone Number</div>
                                                        <div className="text-gray-200">********99</div>
                                                    </div>
                                                    <button className="bg-[#313338] hover:bg-[#404249] text-gray-200 px-4 py-1.5 rounded text-sm font-medium">Edit</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="border-t border-gray-700 pt-6">
                                        <h3 className="text-xs font-bold text-gray-400 uppercase mb-4">Password and Authentication</h3>
                                        
                                        {isChangingPassword ? (
                                            <div className="bg-[#1e1f22] p-4 rounded-lg mb-4 border border-[#404249]">
                                                <h4 className="text-sm font-bold text-white mb-4">Change Password</h4>
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="text-xs font-bold text-gray-400 uppercase block mb-1">Current Password</label>
                                                        <input 
                                                            type="password" 
                                                            className="w-full bg-[#2b2d31] p-2 rounded border border-black/20 focus:border-[#5865F2] focus:outline-none text-white text-sm transition-colors"
                                                            value={passwordForm.current}
                                                            onChange={(e) => setPasswordForm({...passwordForm, current: e.target.value})}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs font-bold text-gray-400 uppercase block mb-1">New Password</label>
                                                        <input 
                                                            type="password" 
                                                            className="w-full bg-[#2b2d31] p-2 rounded border border-black/20 focus:border-[#5865F2] focus:outline-none text-white text-sm transition-colors"
                                                            value={passwordForm.new}
                                                            onChange={(e) => setPasswordForm({...passwordForm, new: e.target.value})}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs font-bold text-gray-400 uppercase block mb-1">Confirm New Password</label>
                                                        <input 
                                                            type="password" 
                                                            className="w-full bg-[#2b2d31] p-2 rounded border border-black/20 focus:border-[#5865F2] focus:outline-none text-white text-sm transition-colors"
                                                            value={passwordForm.confirm}
                                                            onChange={(e) => setPasswordForm({...passwordForm, confirm: e.target.value})}
                                                        />
                                                    </div>
                                                    <div className="flex justify-end space-x-2 pt-2">
                                                        <button 
                                                            onClick={() => setIsChangingPassword(false)}
                                                            className="text-gray-300 hover:underline text-sm px-3 py-2"
                                                        >
                                                            Cancel
                                                        </button>
                                                        <button 
                                                            onClick={handleChangePassword}
                                                            className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors"
                                                        >
                                                            Done
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            <button 
                                                onClick={() => setIsChangingPassword(true)}
                                                className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-4 py-2 rounded text-sm font-medium transition-colors mb-4"
                                            >
                                                Change Password
                                            </button>
                                        )}
                                        
                                        <h3 className="text-xs font-bold text-gray-400 uppercase mb-2 mt-4">Account Removal</h3>
                                        <button className="border border-red-500 text-red-500 hover:bg-red-500/10 px-4 py-2 rounded text-sm font-medium transition-colors">Delete Account</button>
                                    </div>
                                </div>
                            )}

                            {userSettingsTab === 'profiles' && (
                                <div className="animate-in slide-in-from-bottom-4 duration-300">
                                    <h2 className="text-xl font-bold text-white mb-6">Profiles</h2>
                                    
                                    <div className="flex space-x-8">
                                        <div className="flex-1">
                                            <label className="text-xs font-bold text-gray-400 uppercase block mb-2">Display Name</label>
                                            <input 
                                                type="text" 
                                                className="w-full bg-[#1e1f22] p-2.5 rounded border-none focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200 mb-6" 
                                                value={currentUser.name} 
                                                onChange={(e) => setCurrentUser({...currentUser, name: e.target.value})}
                                            />

                                            <label className="text-xs font-bold text-gray-400 uppercase block mb-2">About Me</label>
                                            <textarea 
                                                className="w-full bg-[#1e1f22] p-2.5 rounded border-none focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200 mb-6 h-24 resize-none" 
                                                value={currentUser.about}
                                                onChange={(e) => setCurrentUser({...currentUser, about: e.target.value})}
                                                placeholder="Tell us about yourself!"
                                            />

                                            <label className="text-xs font-bold text-gray-400 uppercase block mb-2">Avatar</label>
                                            <div className="flex items-center space-x-4 mb-6">
                                                <button 
                                                    className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-4 py-2 rounded text-sm font-medium transition-colors"
                                                    onClick={() => userAvatarInputRef.current?.click()}
                                                >
                                                    Change Avatar
                                                </button>
                                                <button 
                                                    className="text-gray-300 hover:underline text-sm"
                                                    onClick={() => setCurrentUser({...currentUser, avatar: 'bg-indigo-400'})}
                                                >
                                                    Remove Avatar
                                                </button>
                                                <input type="file" ref={userAvatarInputRef} className="hidden" accept="image/*" onChange={handleUserAvatarUpload} />
                                            </div>

                                            <label className="text-xs font-bold text-gray-400 uppercase block mb-2">Banner Color</label>
                                            <div className="flex space-x-2 mb-6">
                                                {SERVER_COLORS.map(color => (
                                                    <div 
                                                        key={color} 
                                                        className={`${color} w-8 h-8 rounded-full cursor-pointer hover:scale-110 transition-transform flex items-center justify-center`}
                                                        onClick={() => setCurrentUser({...currentUser, banner: color})}
                                                    >
                                                        {currentUser.banner === color && <Check size={16} className="text-white" />}
                                                    </div>
                                                ))}
                                            </div>
                                            
                                            <label className="text-xs font-bold text-gray-400 uppercase block mb-2">Status</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {['online', 'idle', 'dnd', 'offline'].map(status => (
                                                    <div 
                                                        key={status} 
                                                        className={`p-2 rounded cursor-pointer border flex items-center ${currentUser.status === status ? 'border-[#5865F2] bg-[#5865F2]/10' : 'border-transparent bg-[#1e1f22] hover:bg-[#2b2d31]'}`}
                                                        onClick={() => setCurrentUser({...currentUser, status})}
                                                    >
                                                        <div className={`w-3 h-3 rounded-full mr-2 ${status === 'online' ? 'bg-green-500' : status === 'idle' ? 'bg-yellow-500' : status === 'dnd' ? 'bg-red-500' : 'bg-gray-500'}`}></div>
                                                        <span className="capitalize text-gray-300 text-sm font-medium">{status === 'dnd' ? 'Do Not Disturb' : status === 'offline' ? 'Invisible' : status}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Preview */}
                                        <div className="w-[300px]">
                                            <div className="text-xs font-bold text-gray-400 uppercase mb-2">Preview</div>
                                            <div className="bg-[#2b2d31] rounded-lg overflow-hidden shadow-lg border border-[#1e1f22] relative group">
                                                <div className={`h-16 ${currentUser.banner || 'bg-indigo-500'}`}></div>
                                                <div className="px-4 pb-4 pt-10 relative">
                                                    <div className="absolute -top-8 left-4 p-1.5 bg-[#2b2d31] rounded-full">
                                                        <Avatar user={currentUser} className="w-20 h-20" textSize="text-3xl" statusIndicator={true} />
                                                    </div>
                                                    <div className="text-lg font-bold text-white mb-1">{currentUser.name}</div>
                                                    <div className="text-gray-400 text-xs mb-3">{currentUser.name.toLowerCase()}</div>
                                                    
                                                    <div className="h-px bg-gray-700 mb-3"></div>
                                                    
                                                    <div className="text-xs font-bold text-gray-400 uppercase mb-1">About Me</div>
                                                    <div className="text-sm text-gray-300 text-sm">{currentUser.about || "Just a space traveler."}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
              )}
              
              {/* User Profile Modal (View Other Users) */}
              {activeModal === 'userProfile' && selectedUserProfileId && (
                  <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 animate-in fade-in duration-200" onClick={() => setActiveModal(null)}>
                      {(() => {
                          const user = getUser(selectedUserProfileId);
                          if (!user) return null;
                          const isPlanetKiller = user.id === 'u1';

                          return (
                              <div 
                                className={`text-white rounded-xl shadow-2xl w-full max-w-[600px] overflow-hidden relative ${isPlanetKiller ? 'bg-red-950 animate-shake border-4 border-red-600 shadow-[0_0_50px_rgba(220,38,38,0.5)]' : 'bg-[#111214]'}`} 
                                onClick={e => e.stopPropagation()}
                              >
                                  {/* Planet Killer Special Effects */}
                                  {isPlanetKiller && (
                                    <div className="absolute inset-0 pointer-events-none z-0">
                                        {[...Array(20)].map((_, i) => (
                                            <div 
                                                key={i}
                                                className={`absolute -bottom-4 w-2 h-2 rounded-full ${['bg-red-600', 'bg-orange-500', 'bg-black'][i % 3]}`}
                                                style={{
                                                    left: `${Math.random() * 100}%`,
                                                    animation: `rise ${2 + Math.random() * 3}s infinite linear`,
                                                    animationDelay: `-${Math.random() * 5}s`,
                                                    opacity: 0.6
                                                }}
                                            />
                                        ))}
                                    </div>
                                  )}

                                  <div className={`h-32 relative z-10 ${user.banner || 'bg-indigo-500'}`}></div>
                                  <div className="px-4 pb-4 relative z-10">
                                      <div className={`absolute -top-14 left-4 p-2 rounded-full ${isPlanetKiller ? 'bg-red-950' : 'bg-[#111214]'}`}>
                                          <Avatar user={user} className="w-24 h-24" textSize="text-4xl" statusIndicator={true} />
                                      </div>
                                      <div className="ml-32 pt-2 flex justify-end">
                                          <button 
                                              className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors"
                                              onClick={(e) => {
                                                  handleMessageUser(user.id, e);
                                                  setActiveModal(null);
                                              }}
                                          >
                                              Send Message
                                          </button>
                                      </div>
                                      
                                      <div className={`mt-4 p-4 rounded-lg ${isPlanetKiller ? 'bg-red-900/50 border border-red-500/30' : 'bg-[#2b2d31]'}`}>
                                          <div className="text-xl font-bold text-white flex items-center">
                                              {user.name}
                                              {user.isBot && <BotTag verified={user.isVerified} />}
                                          </div>
                                          <div className="text-sm text-gray-300 mb-4">{user.name.toLowerCase().replace(/\s/g, '')}</div>
                                          
                                          <div className="h-px bg-gray-600 mb-4"></div>
                                          
                                          <div className="mb-4">
                                              <div className="text-xs font-bold text-gray-400 uppercase mb-1">About Me</div>
                                              <div className="text-sm text-gray-200">{user.about || "Just another space traveler."}</div>
                                          </div>
                                          
                                          {user.activity && (
                                              <div className="mb-2">
                                                  <div className="text-xs font-bold text-gray-400 uppercase mb-1">Activity</div>
                                                  <div className="text-sm text-gray-200">{user.activity}</div>
                                              </div>
                                          )}
                                          
                                          <div className="mt-4">
                                              <div className="text-xs font-bold text-gray-400 uppercase mb-1">Member Since</div>
                                              <div className="text-sm text-gray-200">Dec 17, 2023</div>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          );
                      })()}
                  </div>
              )}
              
              {/* Create Channel Modal */}
              {activeModal === 'createChannel' && (
                  <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                    <div className="bg-[#313338] text-white rounded-lg shadow-2xl w-full max-w-md p-6">
                         <h2 className="text-xl font-bold mb-2">Create Channel</h2>
                         <p className="text-gray-400 text-sm mb-4">in {activeServer?.name}</p>
                         <div className="mb-4">
                             <label className="text-xs font-bold text-gray-400 uppercase block mb-2">Channel Name</label>
                             <div className="flex items-center bg-[#1e1f22] rounded p-2">
                                 <Hash size={20} className="text-gray-400 mr-2" />
                                 <input type="text" className="bg-transparent flex-1 focus:outline-none text-white placeholder-gray-500" placeholder="new-channel" value={newChannelName} onChange={(e) => setNewChannelName(e.target.value)} />
                             </div>
                         </div>
                         <div className="flex justify-end space-x-2">
                             <button onClick={() => setActiveModal(null)} className="px-4 py-2 hover:underline text-sm">Cancel</button>
                             <button onClick={createChannel} className="px-6 py-2 bg-indigo-500 hover:bg-indigo-600 rounded font-medium text-sm">Create Channel</button>
                         </div>
                    </div>
                  </div>
              )}

              {/* Edit Channel Modal */}
              {activeModal === 'editChannel' && (
                  <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                    <div className="bg-[#313338] text-white rounded-lg shadow-2xl w-full max-w-md p-6">
                         <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold">Edit Channel</h2>
                            <button onClick={() => setActiveModal(null)} className="text-gray-400 hover:text-white"><X size={24} /></button>
                         </div>
                         
                         <div className="mb-6">
                             <label className="text-xs font-bold text-gray-400 uppercase block mb-2">Channel Name</label>
                             <div className="flex items-center bg-[#1e1f22] rounded p-2">
                                 <Hash size={20} className="text-gray-400 mr-2" />
                                 <input 
                                    type="text" 
                                    className="bg-transparent flex-1 focus:outline-none text-white placeholder-gray-500" 
                                    placeholder="channel-name" 
                                    value={newChannelName} 
                                    onChange={(e) => setNewChannelName(e.target.value)} 
                                 />
                             </div>
                         </div>

                         <div className="flex justify-between items-center pt-2">
                             <button 
                                onClick={deleteChannel}
                                className="px-4 py-2 text-red-500 border border-red-500/50 hover:bg-red-500/10 rounded font-medium text-sm flex items-center"
                             >
                                <Trash size={14} className="mr-2" />
                                Delete Channel
                             </button>
                             <div className="flex space-x-2">
                                <button onClick={() => setActiveModal(null)} className="px-4 py-2 hover:underline text-sm">Cancel</button>
                                <button onClick={updateChannel} className="px-6 py-2 bg-green-600 hover:bg-green-700 rounded font-medium text-sm">Save Changes</button>
                             </div>
                         </div>
                    </div>
                  </div>
              )}

              {/* Leave Server Confirmation Modal */}
              {serverToLeave && (
                  <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                    <div className="bg-[#313338] text-white rounded-lg shadow-2xl w-full max-w-sm p-6 animate-in fade-in zoom-in-95 duration-200">
                        <h2 className="text-xl font-bold mb-2">Leave '{serverToLeave.name}'?</h2>
                        <p className="text-gray-400 text-sm mb-6">Are you sure you want to leave <strong>{serverToLeave.name}</strong>? You won't be able to rejoin unless you are re-invited.</p>
                        <div className="flex justify-end space-x-2">
                            <button onClick={() => setServerToLeave(null)} className="px-4 py-2 hover:underline text-sm text-gray-300">Cancel</button>
                            <button onClick={confirmLeaveServer} className="px-6 py-2 bg-red-500 hover:bg-red-600 rounded font-medium text-sm text-white transition-colors">Leave Server</button>
                        </div>
                    </div>
                  </div>
              )}

              {activeModal === 'discover' && (
                <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                     <div className="bg-[#313338] text-white rounded-lg shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden relative">
                        <div className="relative h-48 bg-gradient-to-r from-indigo-900 to-purple-900 flex flex-col items-center justify-center text-center p-6 flex-shrink-0">
                            <button onClick={() => setActiveModal(null)} className="absolute top-4 right-4 text-white/70 hover:text-white bg-black/20 p-2 rounded-full backdrop-blur-sm"><X size={24} /></button>
                            <h2 className="text-3xl font-bold mb-2">Find your community on Nebula</h2>
                            <div className="mt-6 w-full max-w-lg relative">
                                <input 
                                    type="text" 
                                    placeholder="Explore communities..." 
                                    className="w-full py-3 px-4 pl-10 rounded bg-black/40 border-none focus:outline-none focus:ring-2 focus:ring-white/20 placeholder-gray-400 text-white" 
                                    value={discoverSearch}
                                    onChange={(e) => setDiscoverSearch(e.target.value)}
                                />
                                <Search className="absolute left-3 top-3.5 text-gray-400" size={20} />
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 bg-[#313338] custom-scrollbar">
                            <h3 className="text-xl font-bold mb-4">Featured Communities</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                {discoverableServers
                                    .filter(s => s.name.toLowerCase().includes(discoverSearch.toLowerCase()))
                                    .map(server => (
                                    <div key={server.id} className="bg-[#2b2d31] rounded-lg overflow-hidden hover:shadow-xl hover:bg-[#232428] transition-all group border border-gray-800">
                                        <div className={`h-24 ${server.color} relative`}>
                                            <div className="absolute -bottom-6 left-4 border-4 border-[#2b2d31] rounded-2xl group-hover:border-[#232428] transition-colors">
                                                <div className={`w-12 h-12 flex items-center justify-center bg-gray-700 text-white font-bold rounded-xl text-lg`}>
                                                    {server.img ? <img src={server.img} className="w-full h-full object-cover rounded-xl"/> : server.icon}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="pt-8 px-4 pb-4">
                                            <h4 className="font-bold mb-1">{server.name}</h4>
                                            <p className="text-xs text-gray-400 mb-4 h-8">{server.description}</p>
                                            <button onClick={() => joinServer(server)} className="bg-gray-600 hover:bg-gray-500 text-white px-3 py-1 rounded text-xs font-bold transition-colors">Join</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                     </div>
                </div>
              )}
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<DiscordClone />);
    </script>
</body>
</html>
